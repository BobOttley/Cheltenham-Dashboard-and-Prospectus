<!DOCTYPE html>
<html>
<head>
    <title>Cheltenham College - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        
        .header { background: #1a1a4e; color: white; padding: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.8; }
        
        .tabs { background: white; border-bottom: 2px solid #e9ecef; }
        .tabs-container { max-width: 1600px; margin: 0 auto; display: flex; }
        .tab { padding: 15px 30px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; transition: all 0.2s; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #c9a961; color: #c9a961; }
        
        .content { max-width: 1600px; margin: 0 auto; padding: 30px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 32px; font-weight: bold; color: #c9a961; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 14px; }
        
        .table-container { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: #f8f9fa; padding: 12px 8px; text-align: left; font-weight: 600; color: #1a1a4e; border-bottom: 2px solid #e9ecef; font-size: 13px; }
        td { padding: 12px 8px; border-bottom: 1px solid #e9ecef; font-size: 13px; }
        tr:hover { background: #f8f9fa; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #c9a961; color: white; }
        .btn-primary:hover { background: #b8975a; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-boarding { background: #cfe2ff; color: #084298; }
        .badge-day { background: #fff3cd; color: #664d03; }
        .badge-considering { background: #e7e5e4; color: #44403c; }
        
        .prospectus-link { 
            display: inline-block; background: #1a1a4e; color: white; padding: 6px 12px; 
            border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: 500;
        }
        .prospectus-link:hover { background: #2a2a5e; }
        
        /* Settings Section */
        .settings-container { max-width: 800px; }
        .setting-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .setting-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .setting-title { font-size: 20px; font-weight: 600; color: #1a1a4e; }
        .setting-description { color: #666; line-height: 1.6; margin-bottom: 20px; }
        .setting-status { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .status-indicator.on { background: #10b981; }
        .status-indicator.off { background: #ef4444; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 15px; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: 0.4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background: white; transition: 0.4s; border-radius: 50%; }
        input:checked + .toggle-slider { background: #c9a961; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .toggle-label { font-weight: 600; color: #374151; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 25px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 22px; color: #1a1a4e; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 25px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 10px; }
        
        .email-preview { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 25px; margin: 20px 0; line-height: 1.7; }
        .email-preview pre { white-space: pre-wrap; font-family: inherit; line-height: 1.7; margin: 0; }
        
        .email-meta { background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        .email-meta-row { display: flex; margin-bottom: 12px; }
        .email-meta-label { font-weight: 600; color: #555; min-width: 80px; }
        .email-meta-value { color: #333; }
        
        .copy-btn { background: #c9a961; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 15px; }
        .copy-btn:hover { background: #b8975a; }
        .copy-success { color: #28a745; margin-left: 10px; font-weight: 600; }
        
        .interests-list { font-size: 12px; color: #666; }
        .time { color: #999; font-size: 11px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cheltenham College Admin</h1>
        <p>Manage enquiries, settings, and email drafts</p>
    </div>

    <div class="tabs">
        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('enquiries')">Enquiries</div>
            <div class="tab" onclick="switchTab('settings')">Settings</div>
        </div>
    </div>

    <div class="content">
        <!-- ENQUIRIES TAB -->
        <div id="enquiries-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">-</div>
                    <div class="stat-label">Total Enquiries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">-</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weekCount">-</div>
                    <div class="stat-label">This Week</div>
                </div>
            </div>

            <div class="table-container">
                <button class="btn btn-primary" style="margin-bottom:20px;" onclick="loadEnquiries()">üîÑ Refresh</button>
                <div id="enquiries-content">Loading...</div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings-tab" class="tab-content">
            <div class="settings-container">
                <div class="setting-card">
                    <div class="setting-header">
                        <h2 class="setting-title">Prospectus Auto-Display</h2>
                    </div>
                    
                    <div class="setting-description">
                        Control whether prospectus pages are automatically shown to parents after they submit an enquiry form, or if the admissions team should manually email the link.
                    </div>
                    
                    <div class="setting-status">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText">Loading...</span>
                    </div>
                    
                    <div class="setting-description">
                        <strong>When enabled:</strong> Parents see their personalized prospectus immediately after form submission<br>
                        <strong>When disabled:</strong> Parents see a success message, and the admissions team manually emails the prospectus link
                    </div>
                    
                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoDisplayToggle" onchange="updateSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label" id="toggleLabel">Loading...</span>
                    </div>
                </div>
                
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 20px;">
                    <strong style="color: #92400e;">‚ö†Ô∏è Important:</strong>
                    <p style="color: #92400e; margin-top: 10px; line-height: 1.6;">
                        This setting only affects new enquiries going forward. All existing prospectus links remain accessible and are not affected by this toggle.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- EMAIL DRAFT MODAL -->
    <div id="emailDraftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Email Draft for Jack Avery</h2>
                <button onclick="closeEmailModal()" style="background:none;border:none;font-size:28px;cursor:pointer;color:#999;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="emailDraftContent">Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'enquiries';
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(\`.tab:nth-child(\${tabName === 'enquiries' ? 1 : 2})\`).classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'enquiries') {
                loadEnquiries();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }
        
        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        
        async function loadSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const data = await res.json();
                
                if (data.success) {
                    const autoDisplay = data.settings.auto_display_prospectus;
                    document.getElementById('autoDisplayToggle').checked = autoDisplay;
                    updateSettingsUI(autoDisplay);
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Failed to load settings');
            }
        }
        
        async function updateSettings() {
            const autoDisplay = document.getElementById('autoDisplayToggle').checked;
            
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_display_prospectus: autoDisplay })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    updateSettingsUI(autoDisplay);
                    showNotification('Settings saved successfully!');
                } else {
                    throw new Error('Failed to update settings');
                }
            } catch (error) {
                console.error('Error updating settings:', error);
                alert('Failed to update settings');
                document.getElementById('autoDisplayToggle').checked = !autoDisplay;
            }
        }
        
        function updateSettingsUI(autoDisplay) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const toggleLabel = document.getElementById('toggleLabel');
            
            if (autoDisplay) {
                indicator.className = 'status-indicator on';
                statusText.innerHTML = '<strong>Status: ENABLED</strong> - Prospectus auto-displays after form submission';
                toggleLabel.textContent = 'Auto-display is ON';
            } else {
                indicator.className = 'status-indicator off';
                statusText.innerHTML = '<strong>Status: DISABLED</strong> - Admissions team manually emails prospectus links';
                toggleLabel.textContent = 'Auto-display is OFF';
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:15px 25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;';
            notification.textContent = '‚úì ' + message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        // ========================================
        // ENQUIRIES FUNCTIONS
        // ========================================
        
        async function loadEnquiries() {
            document.getElementById('enquiries-content').innerHTML = '<p style="padding:20px;">Loading...</p>';
            
            try {
                const res = await fetch('/api/admin/enquiries');
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);

                const enquiries = data.enquiries;
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

                document.getElementById('totalCount').textContent = enquiries.length;
                document.getElementById('todayCount').textContent = enquiries.filter(e => new Date(e.created_at) >= today).length;
                document.getElementById('weekCount').textContent = enquiries.filter(e => new Date(e.created_at) >= weekAgo).length;

                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Child</th>
                                <th>Family</th>
                                <th>Email</th>
                                <th>Form Entry</th>
                                <th>Entry Year</th>
                                <th>Boarding</th>
                                <th>Interests</th>
                                <th>University</th>
                                <th>Prospectus</th>
                                <th>Email Draft</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                enquiries.forEach(e => {
                    const createdDate = new Date(e.created_at);
                    const date = createdDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const time = createdDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    
                    const boardingClass = e.boarding?.includes('Boarding') ? 'boarding' : e.boarding?.includes('Day') ? 'day' : 'considering';
                    
                    let interests = [];
                    try {
                        const parsedInterests = JSON.parse(e.interests || '[]');
                        interests = parsedInterests.slice(0, 2);
                    } catch {}
                    
                    let activities = [];
                    try {
                        const parsedActivities = JSON.parse(e.activities || '[]');
                        activities = parsedActivities.slice(0, 2);
                    } catch {}
                    
                    let sports = [];
                    try {
                        const parsedSports = JSON.parse(e.specific_sports || '[]');
                        sports = parsedSports.slice(0, 1);
                    } catch {}
                    
                    const allInterests = [...interests, ...activities, ...sports];
                    const interestsDisplay = allInterests.length > 0 ? allInterests.join(', ') : '-';
                    
                    html += \`
                        <tr>
                            <td>
                                <strong>\${date}</strong><br>
                                <span class="time">\${time}</span>
                            </td>
                            <td><strong>\${e.first_name}</strong></td>
                            <td>\${e.family_surname}</td>
                            <td style="font-size:12px;">\${e.parent_email}</td>
                            <td><strong>\${e.form_entry || '-'}</strong></td>
                            <td>\${e.entry_year || '-'}</td>
                            <td><span class="badge badge-\${boardingClass}">\${e.boarding || '-'}</span></td>
                            <td class="interests-list">\${interestsDisplay}</td>
                            <td style="font-size:11px;">\${e.university || '-'}</td>
                            <td><a href="/prospectus?id=\${e.id}" target="_blank" class="prospectus-link">View</a></td>
                            <td><button class="btn btn-secondary btn-sm" onclick="viewEmailDraft('\${e.id}')">View Draft</button></td>
                        </tr>
                    \`;
                });

                html += '</tbody></table>';
                document.getElementById('enquiries-content').innerHTML = html;

            } catch (error) {
                document.getElementById('enquiries-content').innerHTML = '<p style="padding:20px;color:red;">Error: ' + error.message + '</p>';
            }
        }

        async function viewEmailDraft(enquiryId) {
            document.getElementById('emailDraftModal').classList.add('active');
            document.getElementById('emailDraftContent').innerHTML = '<p>Loading email draft...</p>';
            
            try {
                const res = await fetch('/api/admin/email-draft/' + enquiryId);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                const draft = data.draft;
                
                const html = \`
                    <div class="email-meta">
                        <div class="email-meta-row">
                            <div class="email-meta-label">To:</div>
                            <div class="email-meta-value">\${draft.recipient}</div>
                        </div>
                        <div class="email-meta-row">
                            <div class="email-meta-label">Subject:</div>
                            <div class="email-meta-value"><strong>\${draft.subject}</strong></div>
                        </div>
                        <div class="email-meta-row">
                            <div class="email-meta-label">Status:</div>
                            <div class="email-meta-value">\${draft.status}</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0; display: flex; gap: 10px; border-bottom: 2px solid #e5e7eb;">
                        <button class="view-toggle-btn active" onclick="switchEmailView('\${enquiryId}', 'html')" id="htmlTab-\${enquiryId}" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid #c9a961; font-weight: 600; color: #1a1a4e;">
                            HTML Preview
                        </button>
                        <button class="view-toggle-btn" onclick="switchEmailView('\${enquiryId}', 'text')" id="textTab-\${enquiryId}" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #666;">
                            Plain Text
                        </button>
                    </div>
                    
                    <div id="htmlView-\${enquiryId}" class="email-preview" style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 25px; margin: 20px 0; line-height: 1.7;">
                        \${draft.htmlContent}
                    </div>
                    
                    <div id="textView-\${enquiryId}" class="email-preview" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 25px; margin: 20px 0; line-height: 1.7;">
                        <pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.7; margin: 0;">\${draft.textContent}</pre>
                    </div>
                    
                    <button class="copy-btn" onclick="copyEmailText('\${enquiryId}')">Copy Plain Text</button>
                    <span class="copy-success" id="copySuccess-\${enquiryId}" style="display:none;">‚úì Copied!</span>
                \`;
                
                document.getElementById('emailDraftContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('emailDraftContent').innerHTML = '<p style="color:red;">Error loading email draft: ' + error.message + '</p>';
            }
        }
        
        function switchEmailView(enquiryId, view) {
            const htmlView = document.getElementById('htmlView-' + enquiryId);
            const textView = document.getElementById('textView-' + enquiryId);
            const htmlTab = document.getElementById('htmlTab-' + enquiryId);
            const textTab = document.getElementById('textTab-' + enquiryId);
            
            if (view === 'html') {
                htmlView.style.display = 'block';
                textView.style.display = 'none';
                htmlTab.style.borderBottomColor = '#c9a961';
                htmlTab.style.color = '#1a1a4e';
                textTab.style.borderBottomColor = 'transparent';
                textTab.style.color = '#666';
            } else {
                htmlView.style.display = 'none';
                textView.style.display = 'block';
                htmlTab.style.borderBottomColor = 'transparent';
                htmlTab.style.color = '#666';
                textTab.style.borderBottomColor = '#c9a961';
                textTab.style.color = '#1a1a4e';
            }
        }

        async function copyEmailText(enquiryId) {
            try {
                const res = await fetch('/api/admin/email-draft/' + enquiryId);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                await navigator.clipboard.writeText(data.draft.textContent);
                
                const successEl = document.getElementById('copySuccess-' + enquiryId);
                if (successEl) {
                    successEl.style.display = 'inline';
                    setTimeout(() => {
                        successEl.style.display = 'none';
                    }, 2000);
                }
                
            } catch (error) {
                alert('Error copying email: ' + error.message);
            }
        }

        function closeEmailModal() {
            document.getElementById('emailDraftModal').classList.remove('active');
        }

        document.getElementById('emailDraftModal').addEventListener('click', function(e) {
            if (e.target === this) closeEmailModal();
        });

        // Load enquiries on page load
        loadEnquiries();
    </script>
</body>
</html>
