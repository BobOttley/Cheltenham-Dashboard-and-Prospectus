<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cheltenham College – Personalised Prospectus</title>
  <link rel="stylesheet" href="/css/sites.css">
  
  <!-- Language initialization - must come before loader -->
  <script>
    // Detect language from URL parameter or default to English
    const urlParams = new URLSearchParams(window.location.search);
    window.PROSPECTUS_LANG = urlParams.get('lang') || 'en';
  </script>
  
  <!-- i18n Core Loader - must load before dictionaries -->
  <script src="/js/loader.js"></script>
  
  <!-- Load all i18n dictionaries -->
  <script src="/js/i18n/hero.i18n.dict.js"></script>
  <script src="/js/i18n/key_statistics.i18n.dict.js"></script>
  <script src="/js/i18n/house_system.i18n.dict.js"></script>
  <script src="/js/i18n/pastoral_care.i18n.dict.js"></script>
  <script src="/js/i18n/ccf.i18n.dict.js"></script>
  <script src="/js/i18n/sports.i18n.dict.js"></script>
  <script src="/js/i18n/creative_arts.i18n.dict.js"></script>
  <script src="/js/i18n/sciences_mathematics.i18n.dict.js"></script>
  <script src="/js/i18n/humanities_social.i18n.dict.js"></script>
  <script src="/js/i18n/languages_classics.i18n.dict.js"></script>
  <script src="/js/i18n/applied_vocational.i18n.dict.js"></script>
  <script src="/js/i18n/special_programmes.i18n.dict.js"></script>
  <script src="/js/i18n/student_gallery.i18n.dict.js"></script>
  <script src="/js/i18n/final_hero.i18n.dict.js"></script>
  <script src="/js/i18n/third_form.i18n.dict.js"></script>
  <script src="/js/i18n/third_form_creative_arts.i18n.dict.js"></script>
  <script src="/js/i18n/third_form_humanities.i18n.dict.js"></script>
  <script src="/js/i18n/third_form_languages.i18n.dict.js"></script>
  <script src="/js/i18n/third_form_sciences.i18n.dict.js"></script>
  <script src="/js/i18n/upper_school.i18n.dict.js"></script>
  
  <script>
    // Load the normalised enquiry (single source of truth is server.js)
    async function loadProspectusContext() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) return null;
  
      const res = await fetch(`/api/enquiry/${id}`, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
  
      const json = await res.json();
      if (!json || !json.success) return null;
  
      const ctx = json.data || {};
      window.PROSPECTUS_CTX = ctx;
      window.PENAI_FAMILY_ID = id;
      try { localStorage.setItem('enquiryFormData', JSON.stringify(ctx)); } catch (_) {}
      return ctx;
    }
  
    // Minimal global personalisation for shared tokens (no placeholders)
    function personaliseGlobals(ctx) {
      if (!ctx) return;
      document.querySelectorAll('.child-name').forEach(el => {
        const name = (ctx.childName || '').trim();
        if (name && name !== "[Child's Name]") el.textContent = name;
      });
    }
  
    // Initialise JS modules that declare [data-mod] (from app.js MODULES)
    function initModules(ctx) {
      const reg = window.MODULES || {};
      document.querySelectorAll('[data-mod]').forEach(section => {
        const key = section.getAttribute('data-mod');
        const init = reg[key];
        if (typeof init === 'function') {
          try { init(section, ctx); } catch (e) { console.error(`Init failed for ${key}`, e); }
        }
      });
    }
  
    (async () => {
      const ctx = await loadProspectusContext();
      personaliseGlobals(ctx);
    })();
  </script>

  <style>
    /* Minimal base so content renders cleanly even without full CSS */
    body { margin:0; background:#fff; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .page { max-width: 1280px; margin: 0 auto; padding: 16px; }
    
    /* Language Selector - Cheltenham Branding */
    .lang-selector {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: white;
      border: 2px solid #1a1a4e;
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .lang-btn {
      background: transparent;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      color: #1a1a4e;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .lang-btn:hover {
      background: #f8f9fa;
    }
    
    .lang-btn.active {
      background: #1a1a4e;
      color: white;
    }
    
    .lang-btn.active:hover {
      background: #2a2a5e;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .lang-selector {
        top: 10px;
        left: 10px;
        padding: 2px;
      }
      
      .lang-btn {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <!-- Language Selector -->
  <div class="lang-selector">
    <button class="lang-btn" data-lang="en" onclick="switchLanguage('en')">English</button>
    <button class="lang-btn" data-lang="zh-Hans" onclick="switchLanguage('zh-Hans')">中文</button>
  </div>

  <main id="prospectus-root" class="prospectus">
    <!-- CORE MODULES - Always show -->
    <section class="placeholder" data-mod="hero" data-required="true" data-priority="1"></section>
    <section class="placeholder" data-mod="key_statistics" data-priority="3"></section>
    
    <!-- GENERAL SCHOOL LIFE MODULES - Core school experience -->
    <div class="placeholder" data-mod="house_system" data-priority="10"></div>
    
    <div class="placeholder" data-mod="pastoral_care" data-priority="15"></div>
    
    <div class="placeholder" data-mod="student_gallery" data-priority="20"></div>
    
    <section class="placeholder" data-mod="sports" data-priority="25"></section>
    
    <section class="placeholder" data-mod="ccf" data-priority="30"
             data-visible-when='{"activities":["ccf"]}'></section>
    
    <!-- LOWER SCHOOL MODULES - Only show for Lower/Middle School students -->
    <section class="placeholder" data-mod="third_form" data-priority="35"
             data-visible-when='{"stage":["Lower","Middle","Third Form"]}'></section>
    
    <!-- Third Form Subject Modules - Show based on academic interests -->
    <section class="placeholder" data-mod="third_form_sciences" data-priority="40"
             data-visible-when='{"stage":["Lower","Middle","Third Form"],"academicInterests":["sciences","mathematics"]}'></section>
    
    <section class="placeholder" data-mod="third_form_creative_arts" data-priority="45"
             data-visible-when='{"stage":["Lower","Middle","Third Form"],"academicInterests":["arts"]}'></section>
    
    <section class="placeholder" data-mod="third_form_languages" data-priority="50"
             data-visible-when='{"stage":["Lower","Middle","Third Form"],"academicInterests":["languages"]}'></section>
    
    <section class="placeholder" data-mod="third_form_humanities" data-priority="55"
             data-visible-when='{"stage":["Lower","Middle","Third Form"],"academicInterests":["humanities"]}'></section>
    
    <section class="placeholder" data-mod="special_programmes" data-priority="60"
             data-visible-when='{"stage":["Lower","Middle","Third Form"],"priorities":{"activities":[2,3]}}'></section>
    
    <!-- UPPER SCHOOL MODULES - Only show for Upper/Sixth Form students -->
    <section class="placeholder" data-mod="upper_school" data-priority="65"
             data-visible-when='{"stage":["Upper","Sixth Form","Upper School"]}'></section>
    
    <!-- A Level Subject Modules - Show based on academic interests -->
    <section class="placeholder" data-mod="sciences_mathematics" data-priority="70"
             data-visible-when='{"stage":["Upper","Sixth Form","Upper School"],"academicInterests":["sciences","mathematics"]}'></section>
    
    <section class="placeholder" data-mod="humanities_social" data-priority="75"
             data-visible-when='{"stage":["Upper","Sixth Form","Upper School"]}'></section>
    
    <section class="placeholder" data-mod="languages_classics" data-priority="80"
             data-visible-when='{"stage":["Upper","Sixth Form","Upper School"],"academicInterests":["languages","classics"]}'></section>
    
    <section class="placeholder" data-mod="creative_arts" data-priority="85"
             data-visible-when='{"stage":["Upper","Sixth Form","Upper School"],"academicInterests":["arts"]}'></section>
    
    <section class="placeholder" data-mod="applied_vocational" data-priority="90"
             data-visible-when='{"stage":["Upper","Sixth Form","Upper School"],"academicInterests":["applied_vocational","business","technology","psychology"]}'></section>
    
    <!-- FINAL MODULE - Always show -->
    <section class="placeholder" data-mod="final_hero" data-priority="999" data-required="true"></section>
  </main>
  
  <script defer src="/js/app.js"></script>
  
  <!-- Language Switcher Script -->
  <script>
    function switchLanguage(lang) {
      // Update URL with language parameter
      const url = new URL(window.location.href);
      url.searchParams.set('lang', lang);
      
      // Reload page with new language
      window.location.href = url.toString();
    }
    
    // Set active button on page load
    window.addEventListener('DOMContentLoaded', () => {
      const currentLang = window.PROSPECTUS_LANG || 'en';
      document.querySelectorAll('.lang-btn').forEach(btn => {
        if (btn.dataset.lang === currentLang) {
          btn.classList.add('active');
        }
      });
    });
  </script>
  
  <!-- Emily Chatbot Integration -->
  <script>
    // Wait for PENAI_FAMILY_ID to be set, then load iframe with family_id parameter
    window.addEventListener('load', () => {
      setTimeout(() => {
        const iframe = document.createElement('iframe');
        const familyId = window.PENAI_FAMILY_ID || '';
        iframe.src = `https://emily-cheltenham.onrender.com/embed?family_id=${familyId}`;
        iframe.style.cssText = 'position:fixed;bottom:0;right:0;width:400px;height:700px;border:none;z-index:999;';
        iframe.setAttribute('allow', 'microphone');
        document.body.appendChild(iframe);
      }, 1000);
    });
  </script>
  <script src="/js/module-tracking-enhanced-client.js"></script>

</body>
</html>