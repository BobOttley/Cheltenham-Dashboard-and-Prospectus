<!DOCTYPE html>
<html>
<head>
    <title>Cheltenham College - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        
        .header { background: #1e3a5f; color: white; padding: 30px; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.8; }
        .logout-btn { position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        
        .tabs { background: white; border-bottom: 2px solid #e9ecef; }
        .tabs-container { max-width: 1800px; margin: 0 auto; display: flex; }
        .tab { padding: 15px 30px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; transition: all 0.2s; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #c9a961; color: #c9a961; }
        
        .content { max-width: 1800px; margin: 0 auto; padding: 30px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Stats Cards */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 32px; font-weight: bold; color: #c9a961; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 14px; }
        
        /* Search and Filter Bar */
        .filter-bar { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .filter-row:last-child { margin-bottom: 0; }
        .filter-group { flex: 1; min-width: 200px; }
        .filter-group label { display: block; font-weight: 600; color: #333; margin-bottom: 5px; font-size: 13px; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #c9a961; }
        .filter-actions { display: flex; gap: 10px; align-items: flex-end; }
        
        /* Bulk Actions Bar */
        .bulk-actions-bar { background: #c9a961; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; align-items: center; justify-content: space-between; }
        .bulk-actions-bar.active { display: flex; }
        .bulk-actions-info { font-weight: 600; }
        .bulk-actions-buttons { display: flex; gap: 10px; }
        
        /* Table */
        .table-container { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { background: #f8f9fa; padding: 12px 8px; text-align: left; font-weight: 600; color: #1e3a5f; border-bottom: 2px solid #e9ecef; font-size: 13px; cursor: pointer; user-select: none; position: relative; }
        th:hover { background: #e9ecef; }
        th.sortable::after { content: '‚áÖ'; margin-left: 5px; opacity: 0.3; }
        th.sorted-asc::after { content: '‚Üë'; opacity: 1; }
        th.sorted-desc::after { content: '‚Üì'; opacity: 1; }
        td { padding: 12px 8px; border-bottom: 1px solid #e9ecef; font-size: 13px; }
        tr:hover { background: #f8f9fa; }
        tr.selected { background: #fff3cd !important; }
        
        /* Badges */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-boarding { background: #cfe2ff; color: #084298; }
        .badge-day { background: #fff3cd; color: #664d03; }
        .badge-considering { background: #e7e5e4; color: #44403c; }
        .badge-new { background: #d1f4e0; color: #0f5132; }
        .badge-contacted { background: #cfe2ff; color: #084298; }
        .badge-openday { background: #e0f2fe; color: #075985; }
        .badge-privatetour { background: #fce7f3; color: #9f1239; }
        .badge-followup { background: #fff3cd; color: #664d03; }
        .badge-applying { background: #ddd6fe; color: #5b21b6; }
        .badge-accepted { background: #d1fae5; color: #065f46; }
        .badge-archived { background: #e2e3e5; color: #383d41; }
        .badge-priority { background: #f8d7da; color: #842029; }
        .badge-active { background: #d1f4e0; color: #0f5132; }
        .badge-inactive { background: #f8d7da; color: #842029; }
        .badge-past { background: #e2e3e5; color: #383d41; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; font-size: 14px; }
        .btn-primary { background: #c9a961; color: white; }
        .btn-primary:hover { background: #b8975a; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }
        
        /* Checkbox */
        .checkbox-cell { width: 40px; text-align: center; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        
        /* Priority Star */
        .priority-star { cursor: pointer; font-size: 18px; color: #ddd; }
        .priority-star.active { color: #ffc107; }
        
        /* Links */
        .prospectus-link { display: inline-block; background: #1e3a5f; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: 500; }
        .prospectus-link:hover { background: #2a4a6b; }
        .action-link { color: #c9a961; text-decoration: none; font-weight: 500; font-size: 12px; cursor: pointer; }
        .action-link:hover { text-decoration: underline; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; margin: auto; }
        .modal-header { padding: 25px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 22px; color: #1e3a5f; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 25px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 10px; }
        .close-modal-btn { background: none; border: none; font-size: 28px; cursor: pointer; color: #999; line-height: 1; }
        .close-modal-btn:hover { color: #333; }
        
        /* Enquiry Detail Modal */
        .detail-section { margin-bottom: 25px; }
        .detail-section h3 { font-size: 16px; color: #1e3a5f; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .detail-item { }
        .detail-label { font-weight: 600; color: #666; font-size: 13px; margin-bottom: 4px; }
        .detail-value { color: #333; font-size: 14px; }
        .detail-list { list-style: none; padding: 0; }
        .detail-list li { padding: 5px 0; color: #333; }
        .detail-list li:before { content: "‚Ä¢ "; color: #c9a961; font-weight: bold; margin-right: 8px; }
        
        /* Notes Section */
        .notes-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .note-item { background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #c9a961; }
        .note-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .note-author { font-weight: 600; color: #1e3a5f; font-size: 13px; }
        .note-time { color: #999; font-size: 11px; }
        .note-content { color: #333; font-size: 14px; line-height: 1.5; }
        .add-note-form { margin-top: 15px; }
        .add-note-form textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical; min-height: 80px; }
        
        /* Follow-up Reminder */
        .followup-section { background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px; }
        .followup-date { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .followup-date input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        
        /* Activity Log */
        .activity-log { max-height: 400px; overflow-y: auto; }
        .activity-item { padding: 12px; border-bottom: 1px solid #e9ecef; display: flex; gap: 12px; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 600; color: #1e3a5f; font-size: 14px; margin-bottom: 2px; }
        .activity-description { color: #666; font-size: 13px; margin-bottom: 2px; }
        .activity-time { color: #999; font-size: 11px; }
        
        /* Analytics Charts */
        .chart-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            margin-bottom: 20px;
            max-width: 100%;
            overflow: hidden;
        }

        /* ========================================
   ENHANCED SESSION TRACKING STYLES
   ======================================== */

        /* Session History Styles */
        .session-history-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .session-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .session-history-header h3 {
            font-size: 18px;
            color: #1e3a5f;
            margin: 0;
        }

        .total-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #64748b;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-weight: 700;
            color: #1e3a5f;
        }

        .session-timeline {
            position: relative;
            padding-left: 30px;
        }

        .session-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #3b82f6, #e2e8f0);
        }

        .session-item {
            position: relative;
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .session-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .session-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .session-item.active::before {
            background: #10b981;
            box-shadow: 0 0 0 2px #10b981;
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .session-date {
            font-weight: 600;
            color: #1e3a5f;
            font-size: 15px;
        }

        .session-duration {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #64748b;
        }

        .duration-badge {
            padding: 4px 10px;
            background: #dbeafe;
            color: #075985;
            border-radius: 12px;
            font-weight: 600;
        }

        .session-modules {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .module-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.2s ease;
        }

        .module-badge:hover {
            background: #e2e8f0;
        }

        .module-name {
            color: #475569;
            font-weight: 500;
        }

        .module-time {
            color: #64748b;
            font-size: 12px;
        }

        .session-status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-status-badge.active {
            background: #10b981;
            color: white;
        }

        .session-status-badge.ended {
            background: #e2e8f0;
            color: #64748b;
        }

        .no-sessions-message {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .no-sessions-message .icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Module Details */
        .module-details-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .module-details-grid {
            display: grid;
            gap: 12px;
        }

        .module-detail-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 16px;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .module-detail-name {
            font-weight: 600;
            color: #1e3a5f;
        }

        .module-detail-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #64748b;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box-value {
            font-weight: 700;
            color: #1e3a5f;
            font-size: 16px;
        }

        .stat-box-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-title { 
            font-size: 18px; 
            color: #1e3a5f; 
            margin-bottom: 15px; 
            font-weight: 600; 
        }
        .chart { 
            height: 300px;
            max-height: 300px;
            width: 100% !important;
            max-width: 100% !important;
        }
        .analytics-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px;
            max-width: 100%;
        }
        
        /* Analytics responsive adjustments */
        @media (min-width: 1400px) {
            .analytics-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 1400px;
            }
        }
        
        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            .chart {
                height: 250px;
            }
        }
        
        /* Email Template Settings */
        .template-editor { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .template-editor textarea { width: 100%; min-height: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; }
        .template-variables { background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        .template-variables h4 { font-size: 14px; color: #1e3a5f; margin-bottom: 10px; }
        .variable-tag { display: inline-block; background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; margin: 2px; }
        
        /* Settings */
        .settings-container { max-width: 900px; }
        .setting-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .setting-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .setting-title { font-size: 20px; font-weight: 600; color: #1e3a5f; }
        .setting-description { color: #666; line-height: 1.6; margin-bottom: 20px; }
        .setting-status { display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; }
        .status-indicator.on { background: #10b981; }
        .status-indicator.off { background: #ef4444; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 15px; }
        .toggle-switch { position: relative; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: 0.4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background: white; transition: 0.4s; border-radius: 50%; }
        input:checked + .toggle-slider { background: #c9a961; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .toggle-label { font-weight: 600; color: #374151; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #c9a961; box-shadow: 0 0 0 3px rgba(201,169,97,0.1); }
        
        /* Utilities */
        .text-muted { color: #999; font-size: 11px; }
        .time { color: #999; font-size: 11px; }
        .interests-list { font-size: 12px; color: #666; }
        
        /* Notification */
        .notification { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; display: none; }
        .notification.show { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Loading Spinner */
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #c9a961; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.3; }
        .empty-state-text { font-size: 16px; }
        
        /* Open Days */
        .open-days-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-controls { margin-bottom: 20px; }
        .filter-controls label { display: inline-flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; }
        .open-day-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; border-left: 4px solid #c9a961; }
        .open-day-card.inactive { opacity: 0.6; border-left-color: #ccc; }
        .open-day-header-row { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .open-day-title { font-size: 18px; font-weight: 600; color: #1e3a5f; margin-bottom: 5px; }
        .open-day-date { color: #666; font-size: 14px; margin-bottom: 5px; }
        .open-day-time { color: #888; font-size: 13px; }
        .open-day-description { color: #666; line-height: 1.6; margin: 10px 0; }
        .open-day-booking { color: #c9a961; text-decoration: none; font-weight: 500; font-size: 13px; }
        .open-day-booking:hover { text-decoration: underline; }
        .open-day-actions { display: flex; gap: 10px; margin-top: 15px; }

        /* Follow-up Badge */
        .followup-badge { 
            background: #dc3545; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: 600; 
            margin-left: 8px;
            display: none;
        }
        .followup-badge.active { display: inline-block; }
        
        /* Follow-up Indicator in Table */
        .followup-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        .followup-indicator.overdue {
            background: #fee;
            color: #c00;
        }
        .followup-indicator.today {
            background: #ffc107;
            color: #000;
        }
        .followup-indicator.upcoming {
            background: #cfe2ff;
            color: #084298;
        }
        
        /* Follow-up Card */
        .followup-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #ccc;
            transition: all 0.2s;
        }
        .followup-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .followup-card.overdue {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .followup-card.today {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .followup-card.upcoming {
            border-left-color: #17a2b8;
        }
        
        .followup-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        .followup-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a5f;
        }
        .followup-date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .followup-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #888;
            margin-top: 10px;
        }
        .followup-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Follow-up Filter Tabs */
        .followup-filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .followup-filter-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }
        .followup-filter-tab:hover {
            color: #333;
            background: #f8f9fa;
        }
        .followup-filter-tab.active {
            color: #c9a961;
            border-bottom-color: #c9a961;
        }
        .followup-filter-tab .count {
            background: #e9ecef;
            color: #666;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        .followup-filter-tab.active .count {
            background: #c9a961;
            color: white;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filter-row { flex-direction: column; }
            .filter-group { min-width: 100%; }
            .stats { grid-template-columns: 1fr; }
        }
        /* Metric Cards */
        .analytics-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            border-color: #1e3a5f;
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.1);
        }

        .metric-header {
            margin-bottom: 12px;
        }

        .metric-label {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: #1e3a5f;
            line-height: 1.2;
            margin-bottom: 8px;
        }

        .metric-trend {
            font-size: 13px;
            color: #94a3b8;
        }

        /* Real-time Activity Styles */
        .realtime-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 2px solid #10b981;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
            margin-left: 8px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .active-sessions-list {
            display: grid;
            gap: 12px;
        }

        .active-session-item {
            background: #f8fafc;
            border-left: 4px solid #10b981;
            padding: 16px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .active-session-item.idle {
            border-left-color: #f59e0b;
            opacity: 0.7;
        }

        .session-info {
            display: grid;
            gap: 4px;
        }

        .session-user {
            font-weight: 600;
            color: #1e3a5f;
        }

        .session-details {
            font-size: 13px;
            color: #64748b;
        }

        .session-module {
            display: inline-block;
            background: #e0f2fe;
            color: #075985;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .session-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.viewing {
            background: #10b981;
            color: white;
        }

        .status-badge.idle {
            background: #f59e0b;
            color: white;
        }

        .session-time {
            font-size: 13px;
            color: #64748b;
        }

        .no-active-sessions {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        /* Engagement Score Bar */
        .engagement-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            max-width: 120px;
        }

        .score-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-fill.high {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .score-fill.medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .score-fill.low {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cheltenham College Admin</h1>
        <p>Comprehensive enquiry management and analytics</p>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

    <div class="tabs">
        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('enquiries')">Enquiries</div>
            <div class="tab" onclick="switchTab('followups')">Follow-ups <span class="followup-badge" id="followupBadge"></span></div>
            <div class="tab" onclick="switchTab('prospects')">Top Prospects</div>
            <div class="tab" onclick="switchTab('analytics')">Analytics</div>
            <div class="tab" onclick="switchTab('enhanced')">Enhanced Analytics</div>
            <div class="tab" onclick="switchTab('opendays')">Open Days</div>
            <div class="tab" onclick="switchTab('settings')">Settings</div>
        </div>
    </div>

    <div class="content">
        <!-- ENQUIRIES TAB -->
        <div id="enquiries-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">-</div>
                    <div class="stat-label">Total Enquiries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="newCount">-</div>
                    <div class="stat-label">New</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayCount">-</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="weekCount">-</div>
                    <div class="stat-label">This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="priorityCount">-</div>
                    <div class="stat-label">Priority</div>
                </div>
            </div>

            <!-- Search and Filter Bar -->
            <div class="filter-bar">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>üîç Search</label>
                        <input type="text" id="searchInput" placeholder="Search by name, email, family..." onkeyup="filterEnquiries()">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterStatus" onchange="filterEnquiries()">
                            <option value="">All Statuses</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="openday">Open Day</option>
                            <option value="privatetour">Private Tour</option>
                            <option value="followup">Follow-up</option>
                            <option value="applying">Applying</option>
                            <option value="accepted">Accepted</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Form Entry</label>
                        <select id="filterFormEntry" onchange="filterEnquiries()">
                            <option value="">All Forms</option>
                            <option value="Third Form">Third Form</option>
                            <option value="Fourth Form">Fourth Form</option>
                            <option value="Fifth Form">Fifth Form</option>
                            <option value="Lower Sixth Form">Lower Sixth Form</option>
                            <option value="Upper Sixth Form">Upper Sixth Form</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Boarding Type</label>
                        <select id="filterBoarding" onchange="filterEnquiries()">
                            <option value="">All Types</option>
                            <option value="Boarding">Boarding</option>
                            <option value="Day">Day</option>
                            <option value="Considering">Considering</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Country</label>
                        <select id="filterCountry" onchange="filterEnquiries()">
                            <option value="">All Countries</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="filterDateFrom" onchange="filterEnquiries()">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="filterDateTo" onchange="filterEnquiries()">
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                        <button class="btn btn-primary" onclick="exportEnquiries()">üì• Export CSV</button>
                        <button class="btn btn-primary" onclick="loadEnquiries()">üîÑ Refresh</button>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div class="bulk-actions-bar" id="bulkActionsBar">
                <div class="bulk-actions-info">
                    <span id="selectedCount">0</span> enquiries selected
                </div>
                <div class="bulk-actions-buttons">
                    <button class="btn btn-secondary btn-sm" onclick="bulkMarkContacted()">‚úì Mark Contacted</button>
                    <button class="btn btn-warning btn-sm" onclick="bulkMarkFollowup()">‚è∞ Mark Follow-up</button>
                    <button class="btn btn-info btn-sm" onclick="bulkGenerateEmails()">‚úâÔ∏è Generate Emails</button>
                    <button class="btn btn-danger btn-sm" onclick="bulkArchive()">üì¶ Archive</button>
                    <button class="btn btn-danger btn-sm" onclick="bulkDelete()">üóëÔ∏è Delete</button>
                    <button class="btn btn-secondary btn-sm" onclick="deselectAll()">‚úï Clear</button>
                </div>
            </div>

            <div class="table-container">
                <div id="enquiries-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading enquiries...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLLOW-UPS TAB -->
        <div id="followups-tab" class="tab-content">
            <h2 style="font-size: 24px; color: #1e3a5f; margin-bottom: 20px;">‚è∞ Follow-up Reminders</h2>
            
            <div class="followup-filter-tabs">
                <button class="followup-filter-tab active" onclick="filterFollowups('all')">
                    All <span class="count" id="countAll">0</span>
                </button>
                <button class="followup-filter-tab" onclick="filterFollowups('overdue')">
                    Overdue <span class="count" id="countOverdue">0</span>
                </button>
                <button class="followup-filter-tab" onclick="filterFollowups('today')">
                    Today <span class="count" id="countToday">0</span>
                </button>
                <button class="followup-filter-tab" onclick="filterFollowups('upcoming')">
                    Upcoming <span class="count" id="countUpcoming">0</span>
                </button>
            </div>

            <div id="followups-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading follow-ups...</p>
                </div>
            </div>
        </div>

        <!-- ANALYTICS TAB -->
<div id="analytics-tab" class="tab-content">
    <div style="max-width: 100%; overflow: hidden;">
        <h2 style="font-size: 24px; color: #1e3a5f; margin-bottom: 20px;">Analytics Dashboard</h2>
        
        <div class="analytics-grid">
            <div class="chart-container">
                <div class="chart-title">Monthly Enquiry Trends</div>
                <canvas id="monthlyTrendsChart" class="chart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Country Distribution</div>
                <canvas id="countryChart" class="chart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Form Entry Distribution</div>
                <canvas id="formEntryChart" class="chart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Gender Distribution</div>
                <canvas id="genderChart" class="chart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Boarding vs Day Pupils</div>
                <canvas id="boardingTypeChart" class="chart"></canvas>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Conversion Funnel</div>
                <canvas id="conversionFunnelChart" class="chart"></canvas>
            </div>
        </div>
    </div>
</div>

        <!-- OPEN DAYS TAB -->
        <div id="opendays-tab" class="tab-content">
            <div class="open-days-header">
                <h2 style="font-size: 24px; color: #1e3a5f;">Open Days Management</h2>
                <button class="btn btn-primary" onclick="openAddOpenDayModal()">+ Add Open Day</button>
            </div>

            <div class="filter-controls">
                <label>
                    <input type="checkbox" id="showPastEvents" onchange="loadOpenDays()">
                    Show past events
                </label>
            </div>

            <div id="opendays-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading open days...</p>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings-tab" class="tab-content">
            <div class="settings-container">
                <div class="setting-card">
                    <div class="setting-header">
                        <h2 class="setting-title">Prospectus Auto-Display</h2>
                    </div>
                    
                    <div class="setting-description">
                        Control whether prospectus pages are automatically shown to parents after they submit an enquiry form.
                    </div>
                    
                    <div class="setting-status">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText">Loading...</span>
                    </div>
                    
                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoDisplayToggle" onchange="updateSettings()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label" id="toggleLabel">Loading...</span>
                    </div>
                </div>

                <div class="setting-card">
                    <div class="setting-header">
                        <h2 class="setting-title">Email Template</h2>
                    </div>
                    
                    <div class="setting-description">
                        Customize the email template sent to parents. Use the variables below to personalize emails.
                    </div>
                    
                    <div class="template-variables">
                        <h4>Available Variables:</h4>
                        <span class="variable-tag">{{parent_name}}</span>
                        <span class="variable-tag">{{child_name}}</span>
                        <span class="variable-tag">{{family_surname}}</span>
                        <span class="variable-tag">{{form_entry}}</span>
                        <span class="variable-tag">{{prospectus_link}}</span>
                        <span class="variable-tag">{{school_name}}</span>
                    </div>
                    
                    <div class="template-editor">
                        <textarea id="emailTemplateText" placeholder="Email template...">Dear {{parent_name}},

Thank you for your interest in Cheltenham College for {{child_name}}.

We have prepared a personalized prospectus based on {{child_name}}'s interests and {{form_entry}} entry.

View your personalized prospectus here: {{prospectus_link}}

If you have any questions or would like to arrange a visit, please don't hesitate to contact us.

Best regards,
The Admissions Team
Cheltenham College</textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveEmailTemplate()" style="margin-top: 15px;">Save Template</button>
                </div>
                
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 20px;">
                    <strong style="color: #92400e;">‚ö†Ô∏è Important:</strong>
                    <p style="color: #92400e; margin-top: 10px; line-height: 1.6;">
                        Changes to settings affect new enquiries only. Existing prospectus links remain accessible.
                    </p>
                </div>
            </div>
        </div>
    </div>


    <!-- ============================================ -->
<!-- TOP PROSPECTS TAB -->
<!-- Add this tab content section to your admin.html -->
<!-- ============================================ -->

<div id="prospects-tab" class="tab-content">
    <div style="max-width: 1400px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="font-size: 24px; color: #1e3a5f; margin: 0;">Top Prospects</h2>
            
            <div style="display: flex; gap: 15px; align-items: center;">
                <label style="font-size: 14px; color: #64748b;">Sort by:</label>
                <select id="prospects-sort" onchange="loadTopProspects()" 
                        style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; cursor: pointer;">
                    <option value="visits">Most Visits</option>
                    <option value="time">Most Time Spent</option>
                </select>
                <button onclick="loadTopProspects()" class="btn btn-primary btn-sm">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-label">Total Engaged Prospects</div>
                <div class="stat-value" id="total-prospects">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">High Engagement</div>
                <div class="stat-value" id="high-engagement">-</div>
                <div class="stat-sublabel">Score > 70</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Sessions per Prospect</div>
                <div class="stat-value" id="avg-sessions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Time Spent</div>
                <div class="stat-value" id="avg-time">-</div>
            </div>
        </div>

        <!-- Prospects Table -->
        <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
            <div id="prospects-loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading prospects...</p>
            </div>

            <div id="prospects-table-container" style="overflow-x: auto;">
                <table class="data-table" id="prospects-table">
                    <thead>
                        <tr>
                            <th>Parent Name</th>
                            <th>Student Name</th>
                            <th>Engagement Score</th>
                            <th>Sessions</th>
                            <th>Time Spent</th>
                            <th>Modules Viewed</th>
                            <th>Last Visit</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prospects-tbody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights Modal -->
<div id="ai-insights-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 style="margin: 0; font-size: 22px; color: #1e3a5f;">ü§ñ AI Prospect Analysis</h2>
            <span class="close" onclick="closeAIInsightsModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <div id="ai-insights-loading" style="text-align: center; padding: 40px; display: none;">
                <div class="spinner" style="margin: 0 auto 20px;"></div>
                <p style="color: #64748b;">Analyzing engagement data...</p>
            </div>

            <div id="ai-insights-content" style="display: none;">
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; font-size: 18px; color: #1e3a5f;" id="ai-prospect-name">-</h3>
                            <p style="margin: 0; font-size: 14px; color: #64748b;">Student: <span id="ai-student-name">-</span></p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #64748b;">Generated by</div>
                            <div style="font-size: 14px; font-weight: 600; color: #10b981;">GPT-4o-mini</div>
                        </div>
                    </div>
                </div>

                <div id="ai-insights-text" style="line-height: 1.8; color: #334155; font-size: 15px;">
                    <!-- AI-generated insights will appear here -->
                </div>

                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="copyInsightsToClipboard()" class="btn btn-secondary">
                        üìã Copy to Clipboard
                    </button>
                    <button onclick="closeAIInsightsModal()" class="btn btn-primary" style="margin-left: 10px;">
                        Close
                    </button>
                </div>
            </div>

            <div id="ai-insights-error" style="display: none; padding: 20px; text-align: center;">
                <div style="color: #ef4444; font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                <p style="color: #ef4444; font-size: 16px; font-weight: 600;">Failed to generate insights</p>
                <p style="color: #64748b; font-size: 14px;" id="ai-error-message">-</p>
                <button onclick="closeAIInsightsModal()" class="btn btn-secondary" style="margin-top: 15px;">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Engagement Score Badge */
.engagement-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 13px;
}

.engagement-high {
    background: #dcfce7;
    color: #166534;
}

.engagement-medium {
    background: #fef3c7;
    color: #92400e;
}

.engagement-low {
    background: #fee2e2;
    color: #991b1b;
}

/* Stat Cards */
.stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.stat-label {
    font-size: 13px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1e3a5f;
}

.stat-sublabel {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 4px;
}

/* Data Table Styling */
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: #f8fafc;
}

.data-table th {
    padding: 14px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e2e8f0;
}

.data-table td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 14px;
    color: #1e293b;
}

.data-table tbody tr:hover {
    background: #f8fafc;
}

/* Button Styling */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: #64748b;
    color: white;
}

.btn-secondary:hover {
    background: #475569;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

.btn-ai {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
}

.btn-ai:hover {
    transform: translateY(-2px);
}

/* Modal Styling */
.modal {
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 24px;
}

.close {
    color: #94a3b8;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #64748b;
}

/* Loading Spinner */
.spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #3b82f6;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// ============================================
// TOP PROSPECTS JAVASCRIPT
// Add this to your admin.html <script> section
// ============================================

let currentInsightsText = '';

// Load top prospects
async function loadTopProspects() {
    const sortBy = document.getElementById('prospects-sort').value;
    const loading = document.getElementById('prospects-loading');
    const tableContainer = document.getElementById('prospects-table-container');
    
    loading.style.display = 'block';
    tableContainer.style.display = 'none';
    
    try {
        const response = await fetch(`/api/admin/top-prospects?sortBy=${sortBy}&limit=50`);
        const data = await response.json();
        
        if (data.success) {
            renderProspectsTable(data.prospects);
            updateProspectsSummary(data.prospects);
        } else {
            showError('Failed to load prospects');
        }
    } catch (error) {
        console.error('Error loading prospects:', error);
        showError('Failed to load prospects: ' + error.message);
    } finally {
        loading.style.display = 'none';
        tableContainer.style.display = 'block';
    }
}

function renderProspectsTable(prospects) {
    const tbody = document.getElementById('prospects-tbody');
    
    if (prospects.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">
                    No engaged prospects yet. Check back after parents start viewing prospectuses.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = prospects.map(prospect => {
        const engagementClass = 
            prospect.engagement_score >= 70 ? 'engagement-high' :
            prospect.engagement_score >= 40 ? 'engagement-medium' : 'engagement-low';
        
        const engagementLabel = 
            prospect.engagement_score >= 70 ? 'High' :
            prospect.engagement_score >= 40 ? 'Medium' : 'Low';
        
        const lastVisit = prospect.last_session_at 
            ? new Date(prospect.last_session_at).toLocaleDateString('en-GB')
            : 'N/A';
        
        const statusClass = {
            'new': 'badge-new',
            'contacted': 'badge-contacted',
            'follow-up': 'badge-followup',
            'converted': 'badge-converted',
            'archived': 'badge-archived'
        }[prospect.status] || 'badge-new';
        
        return `
            <tr>
                <td><strong>${escapeHtml(prospect.parent_name || 'N/A')}</strong></td>
                <td>${escapeHtml(prospect.student_name || 'N/A')}</td>
                <td>
                    <span class="engagement-badge ${engagementClass}">
                        ${prospect.engagement_score} - ${engagementLabel}
                    </span>
                </td>
                <td><strong>${prospect.total_sessions}</strong> visit${prospect.total_sessions !== 1 ? 's' : ''}</td>
                <td><strong>${prospect.time_spent_minutes}</strong> min</td>
                <td><strong>${prospect.unique_modules_viewed}</strong> modules</td>
                <td>${lastVisit}</td>
                <td><span class="status-badge ${statusClass}">${prospect.status}</span></td>
                <td>
                    <button onclick="generateAIInsights('${prospect.id}')" class="btn-ai" title="Generate AI insights">
                        ü§ñ Analyze
                    </button>
                    <button onclick="viewEnquiryDetails('${prospect.id}')" class="btn btn-secondary btn-sm" style="margin-left: 5px;">
                        View Details
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateProspectsSummary(prospects) {
    document.getElementById('total-prospects').textContent = prospects.length;
    
    const highEngagement = prospects.filter(p => p.engagement_score >= 70).length;
    document.getElementById('high-engagement').textContent = highEngagement;
    
    const avgSessions = prospects.reduce((sum, p) => sum + p.total_sessions, 0) / prospects.length;
    document.getElementById('avg-sessions').textContent = avgSessions.toFixed(1);
    
    const avgTime = prospects.reduce((sum, p) => sum + p.time_spent_minutes, 0) / prospects.length;
    document.getElementById('avg-time').textContent = Math.round(avgTime) + ' min';
}

// Generate AI insights for a prospect
async function generateAIInsights(enquiryId) {
    const modal = document.getElementById('ai-insights-modal');
    const loading = document.getElementById('ai-insights-loading');
    const content = document.getElementById('ai-insights-content');
    const error = document.getElementById('ai-insights-error');
    
    // Show modal and loading state
    modal.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';
    
    try {
        const response = await fetch('/api/admin/generate-prospect-insights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enquiryId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Store for clipboard copy
            currentInsightsText = data.insights;
            
            // Display insights
            document.getElementById('ai-prospect-name').textContent = data.prospectName || 'N/A';
            document.getElementById('ai-student-name').textContent = data.studentName || 'N/A';
            
            // Format the insights text (convert markdown-style bold to HTML)
            const formattedInsights = data.insights
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            document.getElementById('ai-insights-text').innerHTML = '<p>' + formattedInsights + '</p>';
            
            loading.style.display = 'none';
            content.style.display = 'block';
            
            console.log('‚úÖ AI insights generated. Tokens used:', data.tokensUsed);
        } else {
            throw new Error(data.error || 'Failed to generate insights');
        }
    } catch (err) {
        console.error('Error generating AI insights:', err);
        document.getElementById('ai-error-message').textContent = err.message;
        loading.style.display = 'none';
        error.style.display = 'block';
    }
}

function closeAIInsightsModal() {
    document.getElementById('ai-insights-modal').style.display = 'none';
}

function copyInsightsToClipboard() {
    navigator.clipboard.writeText(currentInsightsText).then(() => {
        alert('‚úÖ Insights copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('‚ùå Failed to copy to clipboard');
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('ai-insights-modal');
    if (event.target === modal) {
        closeAIInsightsModal();
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load prospects when tab is opened
// You'll need to add this to your existing tab switching logic
// Example: document.getElementById('prospects-tab-button').addEventListener('click', loadTopProspects);
</script>

<!-- ============================================ -->
<!-- ALSO ADD THIS TAB BUTTON TO YOUR NAV -->
<!-- Add to your existing tab navigation -->
<!-- ============================================ -->
<!-- 
<button class="tab-button" onclick="switchTab('prospects')" id="prospects-tab-button">
    Top Prospects
</button>
-->
    <!-- ENHANCED ANALYTICS TAB -->
    <!-- COMPLETE ENHANCED ANALYTICS TAB WITH LIVE ACTIVITY -->
<!-- Replace your entire Enhanced Analytics tab in admin.html with this -->

<div id="enhanced-tab" class="tab-content">
    <div class="modules-header">
        <h2 style="font-size: 24px; color: #1e3a5f; font-weight: 600; margin: 0;">Module Analytics</h2>
        <p style="color: #64748b; margin-top: 8px; font-size: 14px;">Track which prospectus modules are viewed and engagement metrics</p>
    </div>

    <!-- Key Metrics - Simplified and Clean -->
    <div class="analytics-summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin: 30px 0;">
        <div class="metric-card" style="background: white; padding: 24px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 13px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Prospectus Opens</div>
            <div id="prospectusOpens" style="font-size: 32px; font-weight: 700; color: #1e3a5f; margin-top: 8px;">-</div>
            <div id="prospectusOpensTrend" style="font-size: 13px; color: #64748b; margin-top: 4px;">-</div>
        </div>
        
        <div class="metric-card" style="background: white; padding: 24px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 13px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Unique Viewers</div>
            <div id="uniqueViewers" style="font-size: 32px; font-weight: 700; color: #1e3a5f; margin-top: 8px;">-</div>
            <div style="font-size: 13px; color: #64748b; margin-top: 4px;">People who opened prospectus</div>
        </div>
        
        <div class="metric-card" style="background: white; padding: 24px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 13px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Avg per User</div>
            <div id="avgViewsPerUser" style="font-size: 32px; font-weight: 700; color: #1e3a5f; margin-top: 8px;">-</div>
            <div style="font-size: 13px; color: #64748b; margin-top: 4px;">Modules viewed per person</div>
        </div>
        
        <div class="metric-card" style="background: white; padding: 24px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 13px; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Engagement Rate</div>
            <div id="engagementRate" style="font-size: 32px; font-weight: 700; color: #1e3a5f; margin-top: 8px;">-</div>
            <div style="font-size: 13px; color: #64748b; margin-top: 4px;">Of prospectus opened</div>
        </div>
    </div>

    <!-- LIVE ACTIVITY SECTION -->
    <div style="background: white; padding: 24px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h3 style="font-size: 18px; color: #1e3a5f; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; animation: pulse 2s infinite;"></span>
                Recent Activity
            </h3>
            <button onclick="refreshRecentActivity()" style="padding: 8px 16px; background: #f1f5f9; border: none; border-radius: 6px; color: #475569; font-size: 13px; cursor: pointer; font-weight: 500;">
                Refresh
            </button>
        </div>
        
        <div id="recentActivityList" style="display: flex; flex-direction: column; gap: 12px;">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Loading recent activity...
            </div>
        </div>
    </div>

    <!-- Module Performance Table - Clean and Useful -->
    <div style="background: white; padding: 24px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 24px;">
        <h3 style="font-size: 18px; color: #1e3a5f; margin: 0 0 20px 0; font-weight: 600;">Module Performance</h3>
        <div class="table-responsive">
            <table class="data-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #e2e8f0;">
                        <th style="text-align: left; padding: 12px; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Module</th>
                        <th style="text-align: center; padding: 12px; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Unique Viewers</th>
                        <th style="text-align: center; padding: 12px; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Views</th>
                        <th style="text-align: center; padding: 12px; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Popularity</th>
                    </tr>
                </thead>
                <tbody id="modulePerformanceTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: #94a3b8;">Loading module data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* Enhanced Tab Styles */
    .metric-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .data-table tbody tr {
        border-bottom: 1px solid #f1f5f9;
        transition: background-color 0.15s;
    }
    
    .data-table tbody tr:hover {
        background-color: #f8fafc;
    }
    
    .data-table tbody td {
        padding: 16px 12px;
        font-size: 14px;
        color: #334155;
    }
    
    .popularity-bar {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .bar-container {
        flex: 1;
        height: 8px;
        background: #f1f5f9;
        border-radius: 4px;
        overflow: hidden;
        max-width: 200px;
    }
    
    .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #2563eb);
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .bar-fill.high {
        background: linear-gradient(90deg, #10b981, #059669);
    }
    
    .bar-fill.medium {
        background: linear-gradient(90deg, #3b82f6, #2563eb);
    }
    
    .bar-fill.low {
        background: linear-gradient(90deg, #f59e0b, #d97706);
    }
    
    /* Live Activity Styles */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .activity-item {
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 3px solid #3b82f6;
        transition: all 0.2s;
    }
    
    .activity-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }
    
    .activity-item.recent {
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .activity-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .activity-name {
        font-weight: 600;
        color: #1e3a5f;
        font-size: 14px;
    }
    
    .activity-time {
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
    }
    
    .activity-module {
        font-size: 13px;
        color: #475569;
        margin-top: 4px;
    }
    
    .activity-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .activity-badge.viewing {
        background: #dcfce7;
        color: #15803d;
    }
</style>

<script>
// ========================================
// ENHANCED ANALYTICS - CLEAN VERSION
// Module Analytics Dashboard JavaScript
// ========================================

// ========================================
// MAIN LOAD FUNCTION
// ========================================

async function loadEnhancedAnalytics() {
    console.log('üîÑ Loading enhanced analytics...');
    
    try {
        const response = await fetch('/api/admin/module-analytics-enhanced');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Analytics data received:', data);
        
        if (!data.success) {
            throw new Error(data.error || 'Unknown error');
        }
        
        // Update all dashboard sections
        updateSummaryCards(data);
        renderModuleTable(data.topModules || []);
        renderRecentActivity(data.activeSessions || []);
        
    } catch (error) {
        console.error('‚ùå Error loading analytics:', error);
        showError(error.message);
    }
}

// ========================================
// SUMMARY CARDS UPDATE
// ========================================

function updateSummaryCards(data) {
    console.log('üìä Updating summary cards...');
    
    const stats = data.engagementStats || {};
    const totalEnquiries = parseInt(stats.total_enquiries) || 0;
    const openedCount = parseInt(stats.opened_count) || 0;
    const totalModuleViews = parseInt(stats.total_module_views) || 0;
    const openRate = totalEnquiries > 0 ? 
        Math.round((openedCount / totalEnquiries) * 100) : 0;
    
    // UNIQUE modules per user (max 15)
    const avgUniqueModules = parseFloat(stats.avg_unique_modules_per_user) || 0;
    const displayUniqueAvg = Math.min(avgUniqueModules, 15).toFixed(1);
    
    // TOTAL views per user (includes revisits)
    const avgTotalViews = openedCount > 0 ? 
        (totalModuleViews / openedCount).toFixed(1) : '0.0';
    
    // Card 1: Prospectus Opens
    updateElement('prospectusOpens', openedCount.toLocaleString());
    updateElement('prospectusOpensTrend', 
        `${openedCount} / ${totalEnquiries}<br>` +
        `<span style="color: #10b981; font-weight: 600;">${openRate}% opened</span>`,
        true
    );
    
    // Card 2: Unique Viewers -> Show unique modules
    updateElement('uniqueViewers', displayUniqueAvg);
    
    // Card 3: Avg per User -> Show total views
    updateElement('avgViewsPerUser', avgTotalViews);
    
    // Card 4: Engagement Rate
    updateElement('engagementRate', `${openRate}%`);
    
    console.log('‚úÖ Summary cards updated:', {
        totalEnquiries,
        openedCount,
        openRate,
        uniqueModules: displayUniqueAvg + ' different modules',
        totalViews: avgTotalViews + ' total views',
        revisitRatio: (parseFloat(avgTotalViews) / parseFloat(displayUniqueAvg)).toFixed(1) + 'x'
    });
}


// ========================================
// MODULE PERFORMANCE TABLE
// ========================================

function renderModuleTable(modules) {
    console.log('üìã Rendering module table:', modules.length, 'modules');
    
    const tbody = document.getElementById('modulePerformanceTableBody');
    
    if (!tbody) {
        console.error('‚ùå Module table body not found');
        return;
    }
    
    // Handle empty state
    if (!modules || modules.length === 0) {
        tbody.innerHTML = createEmptyState(
            'üìä',
            'No module data yet',
            'Data will appear when users start viewing modules'
        );
        return;
    }
    
    // Calculate max viewers for relative engagement percentage
    const maxViewers = Math.max(...modules.map(m => parseInt(m.unique_viewers) || 0));
    
    // Build table rows
    tbody.innerHTML = modules.map(module => {
        const uniqueViewers = parseInt(module.unique_viewers) || 0;
        const totalViews = parseInt(module.total_views) || 0;
        const engagementPercent = maxViewers > 0 ? 
            Math.round((uniqueViewers / maxViewers) * 100) : 0;
        
        return `
            <tr>
                <td style="font-weight: 500;">${formatModuleName(module.module_name)}</td>
                <td style="text-align: center;">${uniqueViewers}</td>
                <td style="text-align: center;">${totalViews}</td>
                <td style="text-align: center;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div style="flex: 1; max-width: 100px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${engagementPercent}%; height: 100%; background: #3b82f6; border-radius: 3px;"></div>
                        </div>
                        <span style="font-size: 13px; color: #64748b; min-width: 40px;">${engagementPercent}%</span>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log('‚úÖ Module table rendered');
}

// ========================================
// RECENT ACTIVITY DISPLAY
// ========================================

async function refreshRecentActivity() {
    console.log('üîÑ Refreshing recent activity...');
    
    try {
        const response = await fetch('/api/admin/recent-module-activity?limit=10');
        
        if (!response.ok) {
            throw new Error('Failed to load activity');
        }
        
        const data = await response.json();
        renderRecentActivity(data.activities || []);
        
    } catch (error) {
        console.error('‚ùå Error loading activity:', error);
        const container = document.getElementById('recentActivityList');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ef4444;">
                    <p style="font-weight: 500;">Unable to load activity</p>
                    <button onclick="refreshRecentActivity()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Try Again
                    </button>
                </div>
            `;
        }
    }
}

function renderRecentActivity(activities) {
    console.log('‚è±Ô∏è Rendering recent activity:', activities.length, 'items');
    
    const container = document.getElementById('recentActivityList');
    
    if (!container) {
        console.error('‚ùå Recent activity container not found');
        return;
    }
    
    // Handle empty state
    if (!activities || activities.length === 0) {
        container.innerHTML = createEmptyState(
            'üìä',
            'No recent activity',
            'Activity will appear here when users view prospectuses'
        );
        return;
    }
    
    // Build activity items
    container.innerHTML = activities.map(activity => {
        const isViewing = activity.status === 'viewing' || 
                         (activity.seconds_ago && activity.seconds_ago < 120);
        const timeAgo = formatTimeAgo(activity.seconds_ago || 0);
        const duration = formatDuration(activity.total_time || 0);
        const familyName = activity.family_surname || 'Unknown';
        const enquiryId = activity.enquiry_id || '';
        
        return `
            <div class="activity-item ${isViewing ? 'active recent' : ''}">
                <div class="activity-header">
                    <span class="activity-name">${escapeHtml(familyName)} Family ${enquiryId ? `(${enquiryId})` : ''}</span>
                    <span class="activity-time">${timeAgo}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <div style="font-size: 13px; color: #64748b;">Total: <strong>${duration}</strong></div>
                    ${isViewing ? 
                        '<span class="activity-badge viewing">VIEWING NOW</span>' : 
                        '<span class="activity-badge">Ended</span>'
                    }
                </div>
            </div>
        `;
    }).join('');
    
    console.log('‚úÖ Recent activity rendered');
}

// ========================================
// ERROR HANDLING
// ========================================

function showError(message) {
    console.error('‚ùå Showing error:', message);
    
    const errorHtml = '<span style="color: #ef4444;">Error</span>';
    
    // Update summary cards
    updateElement('prospectusOpens', errorHtml, true);
    updateElement('prospectusOpensTrend', 'Failed to load data');
    updateElement('uniqueViewers', errorHtml, true);
    updateElement('avgViewsPerUser', errorHtml, true);
    updateElement('engagementRate', errorHtml, true);
    
    // Update table
    const tbody = document.getElementById('modulePerformanceTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <p style="font-weight: 500;">Failed to load analytics</p>
                    <p style="font-size: 14px; margin-top: 8px; color: #64748b;">${escapeHtml(message)}</p>
                    <button onclick="loadEnhancedAnalytics()" style="margin-top: 16px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Try Again
                    </button>
                </td>
            </tr>
        `;
    }
    
    // Update recent activity
    const activityContainer = document.getElementById('recentActivityList');
    if (activityContainer) {
        activityContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <p style="font-weight: 500;">Failed to load recent activity</p>
            </div>
        `;
    }
}

// ========================================
// UTILITY FUNCTIONS
// ========================================

function updateElement(id, content, useInnerHTML = false) {
    const element = document.getElementById(id);
    if (element) {
        if (useInnerHTML) {
            element.innerHTML = content;
        } else {
            element.textContent = content;
        }
    }
}

function createEmptyState(icon, title, subtitle) {
    return `
        <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: #64748b;">
                <div style="font-size: 48px; margin-bottom: 16px;">${icon}</div>
                <p style="font-weight: 500;">${title}</p>
                <p style="font-size: 14px; margin-top: 8px;">${subtitle}</p>
            </td>
        </tr>
    `;
}

function formatModuleName(name) {
    if (!name) return 'Unknown Module';
    return name
        .replace(/_/g, ' ')
        .replace(/\b\w/g, letter => letter.toUpperCase());
}

function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}m ${secs}s`;
}

function formatTimeAgo(seconds) {
    if (seconds < 5) return 'just now';
    if (seconds < 60) return `${seconds} seconds ago`;
    if (seconds < 120) return '1 minute ago';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
    if (seconds < 7200) return '1 hour ago';
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
    return `${Math.floor(seconds / 86400)} days ago`;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ========================================
// AUTO-REFRESH MANAGEMENT
// ========================================

let analyticsRefreshInterval = null;

function startAnalyticsRefresh() {
    console.log('‚ñ∂Ô∏è Starting auto-refresh...');
    
    // Clear any existing interval
    if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
    }
    
    // Set up new interval (refresh every 30 seconds)
    analyticsRefreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refreshing analytics...');
        loadEnhancedAnalytics();
        refreshRecentActivity();
    }, 30000);
}

function stopAnalyticsRefresh() {
    console.log('‚è∏Ô∏è Stopping auto-refresh...');
    
    if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
    }
}

// ========================================
// INITIALIZATION
// ========================================

// Call this from your openTab function when switching to Enhanced Analytics
// Example:
// if (tabName === 'enhanced') {
//     loadEnhancedAnalytics();
//     refreshRecentActivity();
//     startAnalyticsRefresh();
// } else {
//     stopAnalyticsRefresh();
// }
</script>

    <!-- ENQUIRY DETAIL MODAL -->
    <div id="enquiryDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="enquiryDetailTitle">Enquiry Details</h2>
                <button class="close-modal-btn" onclick="closeEnquiryDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="enquiryDetailContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteEnquiry(currentEnquiryId)">üóëÔ∏è Delete Enquiry</button>
                <button class="btn btn-primary" onclick="openEmailClient()">‚úâÔ∏è Send Email</button>
                <button class="btn btn-secondary" onclick="closeEnquiryDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- EMAIL DRAFT MODAL -->
    <div id="emailDraftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Email Draft</h2>
                <button class="close-modal-btn" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="emailDraftContent">Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- OPEN DAY MODAL -->
    <div id="openDayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="openDayModalTitle">Add Open Day</h2>
                <button class="close-modal-btn" onclick="closeOpenDayModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="openDayForm" onsubmit="saveOpenDay(event)">
                    <input type="hidden" id="openDayId">
                    
                    <div class="form-group">
                        <label for="eventName">Event Name *</label>
                        <input type="text" id="eventName" required>
                    </div>

                    <div class="form-group">
                        <label for="eventDate">Date *</label>
                        <input type="date" id="eventDate" required>
                    </div>

                    <div class="form-group">
                        <label for="eventTime">Time</label>
                        <input type="time" id="eventTime">
                    </div>

                    <div class="form-group">
                        <label for="eventDescription">Description</label>
                        <textarea id="eventDescription"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="bookingUrl">Booking URL</label>
                        <input type="url" id="bookingUrl" placeholder="https://">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOpenDayModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('openDayForm').requestSubmit()">Save Open Day</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        // ========================================
        // GLOBAL STATE
        // ========================================
        let currentTab = 'enquiries';
        let allEnquiries = [];
        let filteredEnquiries = [];
        let selectedEnquiries = new Set();
        let currentOpenDays = [];
        let currentEnquiryId = null;
        let sortColumn = 'created_at';
        let sortDirection = 'desc';
        let currentFollowupFilter = 'all';
        let allFollowups = [];

        // ========================================
        // AUTHENTICATION
        // ========================================
        checkAuth();
        
        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/check-auth');
                const data = await res.json();
                if (!data.authenticated) {
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                window.location.href = '/admin/login';
            }
        }
        
        async function handleLogout() {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                window.location.href = '/admin/login';
            } catch (error) {
                alert('Logout failed');
            }
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabIndex = ['enquiries', 'followups', 'prospects', 'analytics', 'enhanced', 'opendays', 'settings'].indexOf(tabName);
            document.querySelectorAll('.tab')[tabIndex].classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Always refresh data when switching tabs
            if (tabName === 'enquiries') {
                loadEnquiries(); // Always refresh enquiries
            } else if (tabName === 'followups') {
                loadFollowups(); // Always refresh follow-ups
            } else if (tabName === 'prospects') {
                loadTopProspects();
            } else if (tabName === 'analytics') {
                loadAnalytics(); // Always refresh analytics charts
            } else if (tabName === 'opendays') {
                loadOpenDays(); // Always refresh open days
            } else if (tabName === 'settings') {
                loadSettings(); // Always refresh settings
            } else if (tabName === 'enhanced') {
                loadEnhancedAnalytics(); // Load enhanced analytics
            }
        }

        // ========================================
        // ENQUIRIES FUNCTIONS
        // ========================================
        async function loadEnquiries() {
            showLoading('enquiries-content');
            
            try {
                const res = await fetch('/api/admin/enquiries');
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);

                allEnquiries = data.enquiries;
                
                // Add default status if not present
                allEnquiries = allEnquiries.map(e => ({
                    ...e,
                    status: e.status || 'new',
                    priority: e.priority || false,
                    notes: e.notes || [],
                    followup_date: e.followup_date || null,
                    email_sent: e.email_sent || false,
                    activities: e.activities || []
                }));
                
                populateCountryFilter();
                filteredEnquiries = [...allEnquiries];
                updateStats();
                filterEnquiries();

            } catch (error) {
                document.getElementById('enquiries-content').innerHTML = 
                    `<div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Error: ${error.message}</div>
                    </div>`;
            }
        }

        function updateStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

            document.getElementById('totalCount').textContent = allEnquiries.length;
            document.getElementById('newCount').textContent = allEnquiries.filter(e => e.status === 'new').length;
            document.getElementById('todayCount').textContent = allEnquiries.filter(e => new Date(e.created_at) >= today).length;
            document.getElementById('weekCount').textContent = allEnquiries.filter(e => new Date(e.created_at) >= weekAgo).length;
            document.getElementById('priorityCount').textContent = allEnquiries.filter(e => e.priority).length;
            
            // Update follow-up badge
            updateFollowupBadge();
        }
        
        function updateFollowupBadge() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const overdueCount = allEnquiries.filter(e => {
                if (!e.followup_date) return false;
                const followupDate = new Date(e.followup_date);
                return followupDate < now && followupDate.toDateString() !== today.toDateString();
            }).length;
            
            const badge = document.getElementById('followupBadge');
            if (overdueCount > 0) {
                badge.textContent = overdueCount;
                badge.classList.add('active');
            } else {
                badge.classList.remove('active');
            }
        }

        // ========================================
        // FOLLOW-UPS FUNCTIONS
        // ========================================
        async function loadFollowups() {
            showLoading('followups-content');
            
            // Get enquiries with follow-up dates
            allFollowups = allEnquiries.filter(e => e.followup_date);
            
            // Sort by followup_date
            allFollowups.sort((a, b) => new Date(a.followup_date) - new Date(b.followup_date));
            
            updateFollowupCounts();
            filterFollowups(currentFollowupFilter);
        }
        
        function updateFollowupCounts() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let overdue = 0, todayCount = 0, upcoming = 0;
            
            allFollowups.forEach(e => {
                const followupDate = new Date(e.followup_date);
                const followupDay = new Date(followupDate.getFullYear(), followupDate.getMonth(), followupDate.getDate());
                
                if (followupDay < today) {
                    overdue++;
                } else if (followupDay.getTime() === today.getTime()) {
                    todayCount++;
                } else {
                    upcoming++;
                }
            });
            
            document.getElementById('countAll').textContent = allFollowups.length;
            document.getElementById('countOverdue').textContent = overdue;
            document.getElementById('countToday').textContent = todayCount;
            document.getElementById('countUpcoming').textContent = upcoming;
        }
        
        function filterFollowups(filter) {
            currentFollowupFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.followup-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event?.target?.classList.add('active');
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            let filtered = allFollowups;
            
            if (filter === 'overdue') {
                filtered = allFollowups.filter(e => {
                    const followupDate = new Date(e.followup_date);
                    const followupDay = new Date(followupDate.getFullYear(), followupDate.getMonth(), followupDate.getDate());
                    return followupDay < today;
                });
            } else if (filter === 'today') {
                filtered = allFollowups.filter(e => {
                    const followupDate = new Date(e.followup_date);
                    const followupDay = new Date(followupDate.getFullYear(), followupDate.getMonth(), followupDate.getDate());
                    return followupDay.getTime() === today.getTime();
                });
            } else if (filter === 'upcoming') {
                filtered = allFollowups.filter(e => {
                    const followupDate = new Date(e.followup_date);
                    const followupDay = new Date(followupDate.getFullYear(), followupDate.getMonth(), followupDate.getDate());
                    return followupDay > today;
                });
            }
            
            renderFollowups(filtered);
        }
        
        function renderFollowups(followups) {
            if (followups.length === 0) {
                document.getElementById('followups-content').innerHTML = 
                    `<div class="empty-state">
                        <div class="empty-state-icon">‚úì</div>
                        <div class="empty-state-text">No follow-ups in this category</div>
                    </div>`;
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            let html = '';
            
            followups.forEach(e => {
                const followupDate = new Date(e.followup_date);
                const followupDay = new Date(followupDate.getFullYear(), followupDate.getMonth(), followupDate.getDate());
                
                let cardClass = 'followup-card';
                let statusBadge = '';
                
                if (followupDay < today) {
                    cardClass += ' overdue';
                    statusBadge = '<span class="badge badge-danger">OVERDUE</span>';
                } else if (followupDay.getTime() === today.getTime()) {
                    cardClass += ' today';
                    statusBadge = '<span class="badge badge-warning">TODAY</span>';
                } else {
                    cardClass += ' upcoming';
                    statusBadge = '<span class="badge badge-info">Upcoming</span>';
                }
                
                const dateStr = followupDate.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                const timeStr = followupDate.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Calculate relative time
                const diffTime = followupDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let relativeTime = '';
                if (diffDays < 0) {
                    relativeTime = `${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} ago`;
                } else if (diffDays === 0) {
                    relativeTime = 'Today';
                } else if (diffDays === 1) {
                    relativeTime = 'Tomorrow';
                } else {
                    relativeTime = `In ${diffDays} days`;
                }
                
                html += `
                    <div class="${cardClass}">
                        <div class="followup-header">
                            <div>
                                <div class="followup-title">
                                    ${e.first_name} ${e.family_surname}
                                    ${statusBadge}
                                </div>
                                <div class="followup-date">
                                    ‚è∞ ${dateStr} at ${timeStr}
                                    <span style="color:#c9a961;font-weight:600;margin-left:10px;">${relativeTime}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="followup-meta">
                            <span>üìß ${e.parent_email}</span>
                            <span>üìã ${e.form_entry || 'N/A'}</span>
                            <span class="badge badge-${e.status}">${e.status}</span>
                        </div>
                        
                        <div class="followup-actions">
                            <button class="btn btn-primary btn-sm" onclick="viewEnquiryDetail('${e.id}')">View Enquiry</button>
                            <button class="btn btn-success btn-sm" onclick="quickCompleteFollowup('${e.id}')">‚úì Mark Complete</button>
                            <button class="btn btn-secondary btn-sm" onclick="openEmailClient(); viewEnquiryDetail('${e.id}')">‚úâÔ∏è Send Email</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('followups-content').innerHTML = html;
        }
        
        async function quickCompleteFollowup(id) {
            try {
                // Clear the follow-up date and mark as contacted
                const res = await fetch(`/api/admin/enquiries/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        followup_date: null,
                        status: 'contacted'
                    })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                // Update local data
                const enquiry = allEnquiries.find(e => e.id === id);
                if (enquiry) {
                    enquiry.followup_date = null;
                    enquiry.status = 'contacted';
                }
                
                showNotification('Follow-up marked as complete');
                loadFollowups();
                updateStats();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        function populateCountryFilter() {
            const countries = [...new Set(allEnquiries.map(e => e.country).filter(Boolean))].sort();
            const filterCountry = document.getElementById('filterCountry');
            const currentValue = filterCountry.value;
            
            filterCountry.innerHTML = '<option value="">All Countries</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                filterCountry.appendChild(option);
            });
            
            if (currentValue && countries.includes(currentValue)) {
                filterCountry.value = currentValue;
            }
        }

        function filterEnquiries() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const formFilter = document.getElementById('filterFormEntry').value;
            const boardingFilter = document.getElementById('filterBoarding').value;
            const countryFilter = document.getElementById('filterCountry').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            filteredEnquiries = allEnquiries.filter(e => {
                // Search filter
                if (searchTerm) {
                    const searchableText = `${e.first_name} ${e.family_surname} ${e.parent_email}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                // Status filter
                if (statusFilter && e.status !== statusFilter) return false;

                // Form entry filter
                if (formFilter && e.form_entry !== formFilter) return false;

                // Boarding filter
                if (boardingFilter) {
                    if (boardingFilter === 'Boarding' && !e.boarding?.includes('Boarding')) return false;
                    if (boardingFilter === 'Day' && !e.boarding?.includes('Day')) return false;
                    if (boardingFilter === 'Considering' && !e.boarding?.includes('Considering')) return false;
                }

                // Country filter
                if (countryFilter && e.country !== countryFilter) return false;

                // Date filters
                if (dateFrom) {
                    const enquiryDate = new Date(e.created_at).toISOString().split('T')[0];
                    if (enquiryDate < dateFrom) return false;
                }
                if (dateTo) {
                    const enquiryDate = new Date(e.created_at).toISOString().split('T')[0];
                    if (enquiryDate > dateTo) return false;
                }

                return true;
            });

            sortEnquiries();
            renderEnquiriesTable();
        }

        function sortEnquiries() {
            filteredEnquiries.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (sortColumn === 'created_at') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function setSortColumn(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            // Update UI
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const th = document.querySelector(`th[data-column="${column}"]`);
            if (th) {
                th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
            
            filterEnquiries();
        }

        function renderEnquiriesTable() {
            if (filteredEnquiries.length === 0) {
                document.getElementById('enquiries-content').innerHTML = 
                    `<div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">No enquiries found matching your filters</div>
                    </div>`;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th class="sortable" data-column="created_at" onclick="setSortColumn('created_at')">Date & Time</th>
                            <th class="sortable" data-column="first_name" onclick="setSortColumn('first_name')">Child</th>
                            <th class="sortable" data-column="family_surname" onclick="setSortColumn('family_surname')">Family</th>
                            <th>Email</th>
                            <th>Contact</th>
                            <th class="sortable" data-column="country" onclick="setSortColumn('country')">Country</th>
                            <th class="sortable" data-column="form_entry" onclick="setSortColumn('form_entry')">Form Entry</th>
                            <th>Entry Year</th>
                            <th>Boarding</th>
                            <th>Interests</th>
                            <th class="sortable" data-column="status" onclick="setSortColumn('status')">Status</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            filteredEnquiries.forEach(e => {
                const createdDate = new Date(e.created_at);
                const date = createdDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                const time = createdDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                
                const boardingClass = e.boarding?.includes('Boarding') ? 'boarding' : e.boarding?.includes('Day') ? 'day' : 'considering';
                
                // Parse interests
                let interests = [];
                let activitiesList = [];
                let sports = [];
                
                try {
                    const interestsData = e.interests;
                    if (interestsData) {
                        if (typeof interestsData === 'string') {
                            interests = JSON.parse(interestsData);
                        } else if (Array.isArray(interestsData)) {
                            interests = interestsData;
                        }
                    }
                } catch (err) {
                    console.error('Error parsing interests:', err);
                }
                
                try {
                    const activitiesData = e.activities_data || e.activities;
                    if (activitiesData) {
                        if (typeof activitiesData === 'string') {
                            activitiesList = JSON.parse(activitiesData);
                        } else if (Array.isArray(activitiesData)) {
                            activitiesList = activitiesData;
                        }
                    }
                } catch (err) {
                    console.error('Error parsing activities:', err);
                }
                
                try {
                    const sportsData = e.specific_sports;
                    if (sportsData) {
                        if (typeof sportsData === 'string') {
                            sports = JSON.parse(sportsData);
                        } else if (Array.isArray(sportsData)) {
                            sports = sportsData;
                        }
                    }
                } catch (err) {
                    console.error('Error parsing sports:', err);
                }
                
                const allInterests = [
                    ...interests.slice(0, 2),
                    ...activitiesList.slice(0, 1),
                    ...sports.slice(0, 1)
                ];
                const interestsDisplay = allInterests.length > 0 
                    ? allInterests.join(', ') 
                    : '<span style="color:#999;">-</span>';

                const isSelected = selectedEnquiries.has(e.id);
                const rowClass = isSelected ? 'selected' : '';
                
                // Follow-up indicator
                let followupIndicator = '';
                if (e.followup_date) {
                    const followupDate = new Date(e.followup_date);
                    const followupDay = new Date(followupDate.getFullYear(), followupDate.getMonth(), followupDate.getDate());
                    
                    if (followupDay < today) {
                        followupIndicator = '<span class="followup-indicator overdue" title="Overdue follow-up">‚ö†Ô∏è</span>';
                    } else if (followupDay.getTime() === today.getTime()) {
                        followupIndicator = '<span class="followup-indicator today" title="Follow-up today">‚è∞</span>';
                    } else {
                        const diffDays = Math.ceil((followupDate - now) / (1000 * 60 * 60 * 24));
                        followupIndicator = `<span class="followup-indicator upcoming" title="Follow-up in ${diffDays} days">üìÖ</span>`;
                    }
                }
                
                html += `
                    <tr class="${rowClass}">
                        <td class="checkbox-cell">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelectEnquiry('${e.id}')">
                        </td>
                        <td>
                            <strong>${date}</strong><br>
                            <span class="time">${time}</span>
                        </td>
                        <td><strong>${e.first_name}</strong></td>
                        <td>${e.family_surname}${followupIndicator}</td>
                        <td style="font-size:12px;">${e.parent_email}</td>
                        <td style="font-size:12px;"><strong>${e.contact_number || '-'}</strong></td>
                        <td style="font-size:12px;"><strong>${e.country || '-'}</strong></td>
                        <td><strong>${e.form_entry || '-'}</strong></td>
                        <td>${e.entry_year || '-'}</td>
                        <td><span class="badge badge-${boardingClass}">${e.boarding || '-'}</span></td>
                        <td class="interests-list">${interestsDisplay}</td>
                        <td><span class="badge badge-${e.status}">${e.status}</span></td>
                        <td>
                            <span class="priority-star ${e.priority ? 'active' : ''}" onclick="togglePriority('${e.id}')">‚òÖ</span>
                        </td>
                        <td>
                            <button class="btn btn-info btn-xs" onclick="viewEnquiryDetail('${e.id}')">View</button>
                            <button class="btn btn-secondary btn-xs" onclick="viewEmailDraft('${e.id}')">Email</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('enquiries-content').innerHTML = html;

            // Update sort indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const sortedTh = document.querySelector(`th[data-column="${sortColumn}"]`);
            if (sortedTh) {
                sortedTh.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterFormEntry').value = '';
            document.getElementById('filterBoarding').value = '';
            document.getElementById('filterCountry').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            filterEnquiries();
        }

        // ========================================
        // BULK ACTIONS
        // ========================================
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox.checked) {
                filteredEnquiries.forEach(e => selectedEnquiries.add(e.id));
            } else {
                selectedEnquiries.clear();
            }
            updateBulkActionsBar();
            renderEnquiriesTable();
        }

        function toggleSelectEnquiry(id) {
            if (selectedEnquiries.has(id)) {
                selectedEnquiries.delete(id);
            } else {
                selectedEnquiries.add(id);
            }
            updateBulkActionsBar();
            renderEnquiriesTable();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = selectedEnquiries.size;
            
            if (count > 0) {
                bar.classList.add('active');
                document.getElementById('selectedCount').textContent = count;
            } else {
                bar.classList.remove('active');
            }
        }

        function deselectAll() {
            selectedEnquiries.clear();
            document.getElementById('selectAll').checked = false;
            updateBulkActionsBar();
            renderEnquiriesTable();
        }

        async function bulkMarkContacted() {
            if (selectedEnquiries.size === 0) {
                alert('Please select at least one enquiry first');
                return;
            }
            
            if (!confirm(`Mark ${selectedEnquiries.size} enquiries as contacted?`)) return;
            
            try {
                const ids = Array.from(selectedEnquiries);
                console.log('Bulk mark contacted - IDs:', ids);
                
                const res = await fetch('/api/admin/enquiries/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, status: 'contacted' })
                });
                
                console.log('Response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Server error: ${res.status} - ${errorText}`);
                }
                
                const data = await res.json();
                console.log('Response data:', data);
                
                if (!data.success) throw new Error(data.error || 'Unknown error');
                
                // Update local data
                allEnquiries.forEach(e => {
                    if (ids.includes(e.id)) {
                        e.status = 'contacted';
                    }
                });
                
                deselectAll();
                filterEnquiries();
                updateStats();
                showNotification(`${ids.length} enquiries marked as contacted`);
            } catch (error) {
                console.error('Bulk contacted error:', error);
                alert('Error marking as contacted: ' + error.message);
            }
        }

        async function bulkMarkFollowup() {
            if (selectedEnquiries.size === 0) {
                alert('Please select at least one enquiry first');
                return;
            }
            
            if (!confirm(`Mark ${selectedEnquiries.size} enquiries for follow-up?`)) return;
            
            try {
                const ids = Array.from(selectedEnquiries);
                console.log('Bulk mark follow-up - IDs:', ids);
                
                const res = await fetch('/api/admin/enquiries/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, status: 'followup' })
                });
                
                console.log('Response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Server error: ${res.status} - ${errorText}`);
                }
                
                const data = await res.json();
                console.log('Response data:', data);
                
                if (!data.success) throw new Error(data.error || 'Unknown error');
                
                // Update local data
                allEnquiries.forEach(e => {
                    if (ids.includes(e.id)) {
                        e.status = 'followup';
                    }
                });
                
                deselectAll();
                filterEnquiries();
                updateStats();
                showNotification(`${ids.length} enquiries marked for follow-up`);
            } catch (error) {
                console.error('Bulk follow-up error:', error);
                alert('Error marking for follow-up: ' + error.message);
            }
        }

        async function bulkArchive() {
            if (selectedEnquiries.size === 0) {
                alert('Please select at least one enquiry first');
                return;
            }
            
            if (!confirm(`Archive ${selectedEnquiries.size} enquiries?`)) return;
            
            try {
                const ids = Array.from(selectedEnquiries);
                console.log('Bulk archive - IDs:', ids);
                
                const res = await fetch('/api/admin/enquiries/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, status: 'archived' })
                });
                
                console.log('Response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Server error: ${res.status} - ${errorText}`);
                }
                
                const data = await res.json();
                console.log('Response data:', data);
                
                if (!data.success) throw new Error(data.error || 'Unknown error');
                
                // Update local data
                allEnquiries.forEach(e => {
                    if (ids.includes(e.id)) {
                        e.status = 'archived';
                    }
                });
                
                deselectAll();
                filterEnquiries();
                updateStats();
                showNotification(`${ids.length} enquiries archived`);
            } catch (error) {
                console.error('Bulk archive error:', error);
                alert('Error archiving enquiries: ' + error.message);
            }
        }

        function bulkGenerateEmails() {
            if (selectedEnquiries.size === 0) {
                alert('Please select at least one enquiry first');
                return;
            }
            
            const ids = Array.from(selectedEnquiries);
            const enquiries = allEnquiries.filter(e => ids.includes(e.id));
            
            console.log('Generating emails for:', enquiries.length, 'enquiries');
            
            // Generate email drafts for all selected
            let emailText = '';
            enquiries.forEach(e => {
                emailText += `TO: ${e.parent_email}\n`;
                emailText += `SUBJECT: Welcome to Cheltenham College - ${e.first_name}'s Personalized Prospectus\n\n`;
                emailText += `Dear ${e.family_surname} Family,\n\n`;
                emailText += `Thank you for your interest in Cheltenham College for ${e.first_name}.\n\n`;
                emailText += `View prospectus: ${window.location.origin}/prospectus?id=${e.id}\n\n`;
                emailText += `Best regards,\nThe Admissions Team\n`;
                emailText += `${'='.repeat(80)}\n\n`;
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(emailText).then(() => {
                showNotification(`${enquiries.length} email drafts copied to clipboard!`);
                deselectAll();
            }).catch(err => {
                console.error('Clipboard error:', err);
                alert('Failed to copy to clipboard. Please try again.');
            });
        }

        async function bulkDelete() {
            if (selectedEnquiries.size === 0) {
                alert('Please select at least one enquiry first');
                return;
            }
            
            const count = selectedEnquiries.size;
            const confirmMessage = `‚ö†Ô∏è WARNING: This will PERMANENTLY DELETE ${count} enquir${count === 1 ? 'y' : 'ies'}.\n\nThis action CANNOT be undone!\n\nAll associated data (notes, activities) will also be deleted.\n\nAre you absolutely sure?`;
            
            if (!confirm(confirmMessage)) return;
            
            // Double confirmation for safety
            if (!confirm(`Final confirmation: Delete ${count} enquir${count === 1 ? 'y' : 'ies'} permanently?`)) return;
            
            try {
                const ids = Array.from(selectedEnquiries);
                console.log('Bulk delete - IDs:', ids);
                
                const res = await fetch('/api/admin/enquiries/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                
                console.log('Delete response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Server error: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('Delete response data:', data);
                
                if (!data.success) throw new Error(data.error || 'Unknown error');
                
                // Remove from local data
                allEnquiries = allEnquiries.filter(e => !ids.includes(e.id));
                
                deselectAll();
                filterEnquiries();
                updateStats();
                showNotification(`${count} enquir${count === 1 ? 'y' : 'ies'} deleted permanently`);
            } catch (error) {
                console.error('Bulk delete error:', error);
                alert('Error deleting enquiries: ' + error.message);
            }
        }

        async function deleteEnquiry(id) {
            if (!id) return;
            
            const enquiry = allEnquiries.find(e => e.id === id);
            if (!enquiry) return;
            
            const confirmMessage = `‚ö†Ô∏è WARNING: Permanently delete enquiry for ${enquiry.first_name} ${enquiry.family_surname}?\n\nThis action CANNOT be undone!\n\nAll associated data (notes, activities) will also be deleted.\n\nAre you absolutely sure?`;
            
            if (!confirm(confirmMessage)) return;
            
            // Double confirmation for safety
            if (!confirm('Final confirmation: Delete this enquiry permanently?')) return;
            
            try {
                console.log('Deleting enquiry:', id);
                
                const res = await fetch(`/api/admin/enquiries/${id}`, {
                    method: 'DELETE'
                });
                
                console.log('Delete response status:', res.status);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Server error: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('Delete response data:', data);
                
                if (!data.success) throw new Error(data.error || 'Unknown error');
                
                // Remove from local data
                allEnquiries = allEnquiries.filter(e => e.id !== id);
                
                // Close modal if open
                closeEnquiryDetailModal();
                
                filterEnquiries();
                updateStats();
                showNotification('Enquiry deleted permanently');
            } catch (error) {
                console.error('Delete enquiry error:', error);
                alert('Error deleting enquiry: ' + error.message);
            }
        }

        // ========================================
        // PRIORITY TOGGLE
        // ========================================
        async function togglePriority(id) {
            const enquiry = allEnquiries.find(e => e.id === id);
            if (!enquiry) return;
            
            const newPriority = !enquiry.priority;
            
            try {
                const res = await fetch(`/api/admin/enquiries/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ priority: newPriority })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                enquiry.priority = newPriority;
                filterEnquiries();
                updateStats();
            } catch (error) {
                console.error('Error toggling priority:', error);
            }
        }

        // ========================================
        // ENQUIRY DETAIL MODAL
        // ========================================
        async function viewEnquiryDetail(id) {
            currentEnquiryId = id;
            const enquiry = allEnquiries.find(e => e.id === id);
            if (!enquiry) return;
            
            document.getElementById('enquiryDetailModal').classList.add('active');
            document.getElementById('enquiryDetailTitle').textContent = `${enquiry.first_name} ${enquiry.family_surname}`;
            
            // Parse interests arrays
            let interests = [];
            let activitiesList = [];
            let sports = [];
            
            try {
                if (enquiry.interests) {
                    interests = typeof enquiry.interests === 'string' ? JSON.parse(enquiry.interests) : enquiry.interests;
                }
            } catch (e) {}
            
            try {
                if (enquiry.activities_data || enquiry.activities) {
                    const data = enquiry.activities_data || enquiry.activities;
                    activitiesList = typeof data === 'string' ? JSON.parse(data) : data;
                }
            } catch (e) {}
            
            try {
                if (enquiry.specific_sports) {
                    sports = typeof enquiry.specific_sports === 'string' ? JSON.parse(enquiry.specific_sports) : enquiry.specific_sports;
                }
            } catch (e) {}
            
            let html = `
                <div class="detail-section">
                    <h3>Family Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Child's Name</div>
                            <div class="detail-value"><strong>${enquiry.first_name}</strong></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Family Surname</div>
                            <div class="detail-value">${enquiry.family_surname}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Parent Email</div>
                            <div class="detail-value">${enquiry.parent_email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contact Number</div>
                            <div class="detail-value"><strong>${enquiry.contact_number || 'Not provided'}</strong></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Country of Origin</div>
                            <div class="detail-value"><strong>${enquiry.country || 'Not specified'}</strong></div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Admission Details</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Form Entry</div>
                            <div class="detail-value"><strong>${enquiry.form_entry || '-'}</strong></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Entry Year</div>
                            <div class="detail-value">${enquiry.entry_year || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Boarding Type</div>
                            <div class="detail-value">${enquiry.boarding || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">University Aspiration</div>
                            <div class="detail-value">${enquiry.university || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Interests & Activities</h3>
                    <div class="detail-grid">
            `;
            
            if (interests.length > 0) {
                html += `
                    <div class="detail-item">
                        <div class="detail-label">Academic Interests</div>
                        <ul class="detail-list">
                            ${interests.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (activitiesList.length > 0) {
                html += `
                    <div class="detail-item">
                        <div class="detail-label">Co-curricular Activities</div>
                        <ul class="detail-list">
                            ${activitiesList.map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (sports.length > 0) {
                html += `
                    <div class="detail-item">
                        <div class="detail-label">Sports</div>
                        <ul class="detail-list">
                            ${sports.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Status & Priority</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Current Status</div>
                            <div class="detail-value">
                                <select id="enquiryStatus" class="badge badge-${enquiry.status}" style="border:none;padding:6px 12px;cursor:pointer;font-weight:600;" onchange="updateEnquiryStatus('${enquiry.id}')">
                                    <option value="new" ${enquiry.status === 'new' ? 'selected' : ''}>New</option>
                                    <option value="contacted" ${enquiry.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                    <option value="openday" ${enquiry.status === 'openday' ? 'selected' : ''}>Open Day</option>
                                    <option value="privatetour" ${enquiry.status === 'privatetour' ? 'selected' : ''}>Private Tour</option>
                                    <option value="followup" ${enquiry.status === 'followup' ? 'selected' : ''}>Follow-up</option>
                                    <option value="applying" ${enquiry.status === 'applying' ? 'selected' : ''}>Applying</option>
                                    <option value="accepted" ${enquiry.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                                    <option value="archived" ${enquiry.status === 'archived' ? 'selected' : ''}>Archived</option>
                                </select>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Priority</div>
                            <div class="detail-value">
                                <span class="priority-star ${enquiry.priority ? 'active' : ''}" onclick="togglePriority('${enquiry.id}')" style="font-size:24px;">‚òÖ</span>
                                <span style="margin-left:10px;">${enquiry.priority ? 'Priority Enquiry' : 'Standard'}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email Sent</div>
                            <div class="detail-value">${enquiry.email_sent ? '‚úì Yes' : '‚úó Not yet'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Prospectus Link</div>
                            <div class="detail-value">
                                <a href="/prospectus?id=${enquiry.id}" target="_blank" class="prospectus-link">View Prospectus</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Follow-up reminder section
            html += `
                <div class="followup-section">
                    <h4 style="margin-bottom:10px;color:#333;">‚è∞ Follow-up Reminder</h4>
                    <div class="followup-date">
                        <input type="date" id="followupDate" value="${enquiry.followup_date ? enquiry.followup_date.split('T')[0] : ''}" style="margin-right:10px;">
                        <input type="time" id="followupTime" value="${enquiry.followup_date ? new Date(enquiry.followup_date).toTimeString().slice(0,5) : '09:00'}" style="margin-right:10px;">
                        <button class="btn btn-sm btn-primary" onclick="updateFollowupDate('${enquiry.id}')">Set Reminder</button>
                        ${enquiry.followup_date ? `<button class="btn btn-sm btn-secondary" onclick="clearFollowupDate('${enquiry.id}')">Clear</button>` : ''}
                    </div>
                    ${enquiry.followup_date ? `<p style="margin-top:5px;color:#666;font-size:13px;">Reminder set for: ${new Date(enquiry.followup_date).toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'})} at ${new Date(enquiry.followup_date).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}</p>` : ''}
                </div>
            `;
            
            // Notes section
            html += `
                <div class="notes-section">
                    <h4 style="margin-bottom:15px;color:#333;">üìù Admin Notes</h4>
            `;
            
            if (enquiry.notes && enquiry.notes.length > 0) {
                enquiry.notes.forEach(note => {
                    const noteDate = new Date(note.created_at);
                    html += `
                        <div class="note-item">
                            <div class="note-header">
                                <span class="note-author">${note.author || 'Admin'}</span>
                                <span class="note-time">${noteDate.toLocaleDateString('en-GB')} at ${noteDate.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                            <div class="note-content">${note.content}</div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color:#999;font-style:italic;">No notes yet</p>';
            }
            
            html += `
                    <div class="add-note-form">
                        <textarea id="newNoteContent" placeholder="Add a note about this enquiry..."></textarea>
                        <button class="btn btn-primary" style="margin-top:10px;" onclick="addNote('${enquiry.id}')">Add Note</button>
                    </div>
                </div>
            `;
            
            // Activity log - fetch from backend
            html += `
                <div class="detail-section">
                    <h3>üìä Activity Log</h3>
                    <div class="activity-log" id="activityLogContent-${enquiry.id}">
                        <p style="color:#999;text-align:center;padding:20px;">Loading activities...</p>
                    </div>
                </div>
            `;
            
            // Add the session sections to the HTML
            html += `
                <!-- SESSION HISTORY SECTION -->
                <div id="sessionHistorySection" class="session-history-section" style="display: block;">
                    <div class="session-history-header">
                        <h3>üìñ Session History</h3>
                        <div class="total-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="totalSessionsCount">0</span>
                                <span>sessions</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="totalTimeSpent">0m</span>
                                <span>total time</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="uniqueModulesViewed">0</span>
                                <span>modules</span>
                            </div>
                        </div>
                    </div>
                    <div id="sessionHistoryContent">
                        <div class="loading">Loading sessions...</div>
                    </div>
                </div>

                <!-- MODULE DETAILS SECTION -->
                <div id="moduleDetailsSection" class="module-details-section" style="display: block;">
                    <h3 style="margin-bottom: 16px; color: #1e3a5f; font-weight: 600;">Module Details</h3>
                    <div id="moduleDetailsContent">
                        <div class="loading">Loading module details...</div>
                    </div>
                </div>
            `;

            document.getElementById('enquiryDetailContent').innerHTML = html;

// Load enhanced session tracking data
loadEnquirySessions(enquiry.id);       
            
            // Load activities from backend
            loadActivities(enquiry.id);
        }

        function closeEnquiryDetailModal() {
            document.getElementById('enquiryDetailModal').classList.remove('active');
            currentEnquiryId = null;
        }

        async function loadActivities(enquiryId) {
            try {
                const res = await fetch(`/api/admin/enquiries/${enquiryId}/activities`);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                const activityLogEl = document.getElementById(`activityLogContent-${enquiryId}`);
                if (!activityLogEl) return;
                
                const activities = data.activities || [];
                
                // Activity type icons
                const iconMap = {
                    'enquiry_submitted': 'üìß',
                    'email_sent': '‚úâÔ∏è',
                    'status_changed': 'üîÑ',
                    'priority_changed': '‚≠ê',
                    'followup_set': '‚è∞',
                    'followup_cleared': 'üîï',
                    'note_added': 'üìù',
                    'prospectus_viewed': 'üëÅÔ∏è'
                };
                
                if (activities.length === 0) {
                    activityLogEl.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No activity yet</p>';
                    return;
                }
                
                let html = '';
                activities.forEach(activity => {
                    const activityDate = new Date(activity.created_at);
                    const icon = iconMap[activity.activity_type] || 'üìå';
                    
                    html += `
                        <div class="activity-item">
                            <div class="activity-icon">${icon}</div>
                            <div class="activity-content">
                                <div class="activity-title">${formatActivityTitle(activity.activity_type)}</div>
                                <div class="activity-description">${activity.description || ''}</div>
                                <div class="activity-time">${activityDate.toLocaleDateString('en-GB')} at ${activityDate.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}</div>
                            </div>
                        </div>
                    `;
                });
                
                activityLogEl.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading activities:', error);
                const activityLogEl = document.getElementById(`activityLogContent-${enquiryId}`);
                if (activityLogEl) {
                    activityLogEl.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">Unable to load activities</p>';
                }
            }
        }
        
        function formatActivityTitle(activityType) {
            const titles = {
                'enquiry_submitted': 'Enquiry Submitted',
                'email_sent': 'Email Sent',
                'status_changed': 'Status Changed',
                'priority_changed': 'Priority Changed',
                'followup_set': 'Follow-up Reminder Set',
                'followup_cleared': 'Follow-up Cleared',
                'note_added': 'Note Added',
                'prospectus_viewed': 'Prospectus Viewed'
            };
            return titles[activityType] || activityType;
        }

        async function updateEnquiryStatus(id) {
            const newStatus = document.getElementById('enquiryStatus').value;
            
            try {
                const res = await fetch(`/api/admin/enquiries/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const enquiry = allEnquiries.find(e => e.id === id);
                if (enquiry) {
                    enquiry.status = newStatus;
                }
                
                filterEnquiries();
                updateStats();
                showNotification('Status updated');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function updateFollowupDate(id) {
            const followupDate = document.getElementById('followupDate').value;
            const followupTime = document.getElementById('followupTime').value;
            
            if (!followupDate) {
                alert('Please select a date');
                return;
            }
            
            // Combine date and time into ISO datetime string
            const followupDateTime = `${followupDate}T${followupTime}:00`;
            
            try {
                const res = await fetch(`/api/admin/enquiries/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ followup_date: followupDateTime })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const enquiry = allEnquiries.find(e => e.id === id);
                if (enquiry) {
                    enquiry.followup_date = followupDateTime;
                }
                
                showNotification('‚úÖ Follow-up reminder set successfully!');
                updateStats();
                viewEnquiryDetail(id); // Refresh the modal
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function clearFollowupDate(id) {
            if (!confirm('Clear this follow-up reminder?')) return;
            
            try {
                const res = await fetch(`/api/admin/enquiries/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ followup_date: null })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const enquiry = allEnquiries.find(e => e.id === id);
                if (enquiry) {
                    enquiry.followup_date = null;
                }
                
                showNotification('Follow-up reminder cleared');
                updateStats();
                viewEnquiryDetail(id);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function addNote(id) {
            const content = document.getElementById('newNoteContent').value.trim();
            
            if (!content) {
                alert('Please enter a note');
                return;
            }
            
            try {
                const res = await fetch(`/api/admin/enquiries/${id}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const enquiry = allEnquiries.find(e => e.id === id);
                if (enquiry) {
                    enquiry.notes = enquiry.notes || [];
                    enquiry.notes.push({
                        content,
                        author: 'Admin',
                        created_at: new Date().toISOString()
                    });
                }
                
                showNotification('Note added');
                viewEnquiryDetail(id);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function openEmailClient() {
            if (!currentEnquiryId) return;
            
            const enquiry = allEnquiries.find(e => e.id === currentEnquiryId);
            if (!enquiry) return;
            
            const subject = encodeURIComponent(`Welcome to Cheltenham College - ${enquiry.first_name}'s Personalized Prospectus`);
            const body = encodeURIComponent(
                `Dear ${enquiry.family_surname} Family,\n\n` +
                `Thank you for your interest in Cheltenham College for ${enquiry.first_name}.\n\n` +
                `We have prepared a personalized prospectus based on ${enquiry.first_name}'s interests and ${enquiry.form_entry} entry.\n\n` +
                `View your personalized prospectus here:\n${window.location.origin}/prospectus?id=${enquiry.id}\n\n` +
                `If you have any questions or would like to arrange a visit, please don't hesitate to contact us.\n\n` +
                `Best regards,\nThe Admissions Team\nCheltenham College`
            );
            
            window.location.href = `mailto:${enquiry.parent_email}?subject=${subject}&body=${body}`;
            
            // Mark email as sent
            setTimeout(async () => {
                try {
                    await fetch(`/api/admin/enquiries/${enquiry.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email_sent: true })
                    });
                    
                    enquiry.email_sent = true;
                    showNotification('Email client opened - marked as sent');
                } catch (error) {
                    console.error('Error marking email as sent:', error);
                }
            }, 1000);
        }

        // ========================================
        // EMAIL DRAFT MODAL
        // ========================================
        async function viewEmailDraft(enquiryId) {
            document.getElementById('emailDraftModal').classList.add('active');
            document.getElementById('emailDraftContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading email draft...</p></div>';
            
            try {
                const res = await fetch('/api/admin/email-draft/' + enquiryId);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                const draft = data.draft;
                
                const html = `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                        <div style="margin-bottom:12px;"><strong>To:</strong> ${draft.recipient}</div>
                        <div style="margin-bottom:12px;"><strong>Subject:</strong> ${draft.subject}</div>
                    </div>
                    
                    <div style="margin: 20px 0; display: flex; gap: 10px; border-bottom: 2px solid #e5e7eb;">
                        <button class="view-toggle-btn active" onclick="switchEmailView('${enquiryId}', 'html')" id="htmlTab-${enquiryId}" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid #c9a961; font-weight: 600; color: #1e3a5f;">
                            HTML Preview
                        </button>
                        <button class="view-toggle-btn" onclick="switchEmailView('${enquiryId}', 'text')" id="textTab-${enquiryId}" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #666;">
                            Plain Text
                        </button>
                    </div>
                    
                    <div id="htmlView-${enquiryId}" style="background: white; border: 1px solid #e5e7eb; border-radius: 6px; padding: 25px; margin: 20px 0; line-height: 1.7;">
                        ${draft.htmlContent}
                    </div>
                    
                    <div id="textView-${enquiryId}" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 25px; margin: 20px 0; line-height: 1.7;">
                        <pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.7; margin: 0;">${draft.textContent}</pre>
                    </div>
                    
                    <button class="btn btn-primary" onclick="copyEmailText('${enquiryId}')">üìã Copy Plain Text</button>
                    <span class="copy-success" id="copySuccess-${enquiryId}" style="display:none;color:#28a745;margin-left:10px;font-weight:600;">‚úì Copied!</span>
                `;
                
                document.getElementById('emailDraftContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('emailDraftContent').innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-text">Error: ${error.message}</div></div>`;
            }
        }
        
        function switchEmailView(enquiryId, view) {
            const htmlView = document.getElementById('htmlView-' + enquiryId);
            const textView = document.getElementById('textView-' + enquiryId);
            const htmlTab = document.getElementById('htmlTab-' + enquiryId);
            const textTab = document.getElementById('textTab-' + enquiryId);
            
            if (view === 'html') {
                htmlView.style.display = 'block';
                textView.style.display = 'none';
                htmlTab.style.borderBottomColor = '#c9a961';
                htmlTab.style.color = '#1e3a5f';
                textTab.style.borderBottomColor = 'transparent';
                textTab.style.color = '#666';
            } else {
                htmlView.style.display = 'none';
                textView.style.display = 'block';
                htmlTab.style.borderBottomColor = 'transparent';
                htmlTab.style.color = '#666';
                textTab.style.borderBottomColor = '#c9a961';
                textTab.style.color = '#1e3a5f';
            }
        }

        async function copyEmailText(enquiryId) {
            try {
                const res = await fetch('/api/admin/email-draft/' + enquiryId);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                await navigator.clipboard.writeText(data.draft.textContent);
                
                const successEl = document.getElementById('copySuccess-' + enquiryId);
                if (successEl) {
                    successEl.style.display = 'inline';
                    setTimeout(() => {
                        successEl.style.display = 'none';
                    }, 2000);
                }
                
            } catch (error) {
                alert('Error copying email: ' + error.message);
            }
        }

        function closeEmailModal() {
            document.getElementById('emailDraftModal').classList.remove('active');
        }

        // ========================================
        // ANALYTICS FUNCTIONS
        // ========================================
        let chartInstances = {};

        async function loadAnalytics() {
            // Always reinitialize charts when switching to analytics tab
            await initializeCharts();
        }
        function getCountryDistribution() {
            const counts = {};
            
            allEnquiries.forEach(e => {
                const country = e.country || 'Unknown';
                counts[country] = (counts[country] || 0) + 1;
            });
            
            // Sort by count descending and take top 10
            const sorted = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            return {
                labels: sorted.map(([country]) => country),
                data: sorted.map(([, count]) => count)
            };
        }
        async function initializeCharts() {
            // Destroy existing charts if they exist
            if (chartInstances.monthly) chartInstances.monthly.destroy();
            if (chartInstances.formEntry) chartInstances.formEntry.destroy();
            if (chartInstances.gender) chartInstances.gender.destroy();
            if (chartInstances.boarding) chartInstances.boarding.destroy();
            if (chartInstances.conversion) chartInstances.conversion.destroy();
            if (chartInstances.country) chartInstances.country.destroy();
            
            // Get data for charts
            const monthlyData = getMonthlyTrends();
            const formEntryData = getFormEntryDistribution();
            const genderData = getGenderDistribution();
            const boardingData = getBoardingDistribution();
            const conversionData = getConversionFunnel();
            
            
            // Professional color palettes
            const corporateColors = {
                // Distinct, professional colors for 5+ categories
                multiCategory: [
                    '#2563eb', // Professional Blue
                    '#dc2626', // Corporate Red
                    '#059669', // Business Green
                    '#d97706', // Executive Orange
                    '#7c3aed', // Premium Purple
                    '#0891b2', // Teal
                    '#e11d48'  // Rose
                ],
                // Professional gradient for trends (blue to indigo)
                trend: {
                    line: '#2563eb',
                    fill: 'rgba(37, 99, 235, 0.1)'
                },
                // Distinct 3-color palette for boarding
                boarding: [
                    '#2563eb', // Primary Blue
                    '#059669', // Success Green
                    '#d97706'  // Neutral Orange
                ],
                // Professional gradient for conversion funnel (6 stages)
                funnel: [
                    '#10b981', // Start Green (New)
                    '#3b82f6', // Progress Blue (Contacted)
                    '#8b5cf6', // Visit Purple (Open Day/Tour)
                    '#f59e0b', // Follow-up Orange (Follow-up)
                    '#6366f1', // Applying Indigo (Applying)
                    '#059669'  // Success Green (Accepted)
                ]
            };

            // Common responsive options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                family: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
                            },
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 8,
                            boxHeight: 8
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        boxWidth: 12,
                        boxHeight: 12,
                        boxPadding: 6
                    }
                }
            };

            // Monthly Trends Chart - Professional line chart
            const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
            chartInstances.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Enquiries',
                        data: monthlyData.data,
                        borderColor: corporateColors.trend.line,
                        backgroundColor: corporateColors.trend.fill,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointBackgroundColor: corporateColors.trend.line,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: corporateColors.trend.line,
                        pointHoverBorderWidth: 3,
                        borderWidth: 3
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 11
                                },
                                color: '#64748b'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 0,
                                color: '#64748b'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Country Distribution Chart
            const countryData = getCountryDistribution();
            const countryCtx = document.getElementById('countryChart').getContext('2d');
            const countryTotal = countryData.data.reduce((a, b) => a + b, 0);

            chartInstances.country = new Chart(countryCtx, {
                type: 'doughnut',
                data: {
                    labels: countryData.labels,
                    datasets: [{
                        data: countryData.data,
                        backgroundColor: [
                            '#2563eb', '#dc2626', '#059669', '#d97706', '#7c3aed',
                            '#0891b2', '#e11d48', '#f59e0b', '#8b5cf6', '#10b981'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = ((value / countryTotal) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            // Form Entry Chart - Professional doughnut with distinct colors
            const formCtx = document.getElementById('formEntryChart').getContext('2d');
            const formTotal = formEntryData.data.reduce((a, b) => a + b, 0);
            chartInstances.formEntry = new Chart(formCtx, {
                type: 'doughnut',
                data: {
                    labels: formEntryData.labels,
                    datasets: [{
                        data: formEntryData.data,
                        backgroundColor: corporateColors.multiCategory,
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff',
                        hoverOffset: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    cutout: '65%',
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            position: 'right'
                        },
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = ((value / formTotal) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gender Distribution Chart - Professional pie chart
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            const genderTotal = genderData.data.reduce((a, b) => a + b, 0);
            chartInstances.gender = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: genderData.labels,
                    datasets: [{
                        data: genderData.data,
                        backgroundColor: ['#2563eb', '#ec4899'], // Professional Blue for Boys, Pink for Girls
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff',
                        hoverOffset: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            position: 'right'
                        },
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = ((value / genderTotal) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Boarding Type Chart - Professional pie with distinct colors
            const boardingCtx = document.getElementById('boardingTypeChart').getContext('2d');
            const boardingTotal = boardingData.data.reduce((a, b) => a + b, 0);
            chartInstances.boarding = new Chart(boardingCtx, {
                type: 'pie',
                data: {
                    labels: boardingData.labels,
                    datasets: [{
                        data: boardingData.data,
                        backgroundColor: corporateColors.boarding,
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#fff',
                        hoverOffset: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: {
                            ...commonOptions.plugins.legend,
                            position: 'right'
                        },
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = ((value / boardingTotal) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Conversion Funnel Chart - Professional bar chart with gradient
            const conversionCtx = document.getElementById('conversionFunnelChart').getContext('2d');
            const conversionTotal = conversionData.data.reduce((a, b) => a + b, 0);
            chartInstances.conversion = new Chart(conversionCtx, {
                type: 'bar',
                data: {
                    labels: conversionData.labels,
                    datasets: [{
                        label: 'Count',
                        data: conversionData.data,
                        backgroundColor: corporateColors.funnel,
                        borderRadius: 8,
                        borderSkipped: false,
                        hoverBackgroundColor: corporateColors.funnel.map(color => color + 'dd')
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { display: false },
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const percentage = ((value / conversionTotal) * 100).toFixed(1);
                                    return `Count: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 11
                                },
                                stepSize: 1,
                                color: '#64748b'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                color: '#64748b'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function getMonthlyTrends() {
            const months = {};
            const now = new Date();
            
            // Initialize last 12 months
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                months[key] = 0;
            }
            
            // Count enquiries per month
            allEnquiries.forEach(e => {
                const date = new Date(e.created_at);
                const key = date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                if (months.hasOwnProperty(key)) {
                    months[key]++;
                }
            });
            
            return {
                labels: Object.keys(months),
                data: Object.values(months)
            };
        }

        function getFormEntryDistribution() {
            const counts = {
                'Third Form': 0,
                'Fourth Form': 0,
                'Fifth Form': 0,
                'Lower Sixth Form': 0,
                'Upper Sixth Form': 0
            };
            
            allEnquiries.forEach(e => {
                if (counts.hasOwnProperty(e.form_entry)) {
                    counts[e.form_entry]++;
                }
            });
            
            return {
                labels: Object.keys(counts),
                data: Object.values(counts)
            };
        }

        function getBoardingDistribution() {
            const counts = {
                'Boarding': 0,
                'Day': 0,
                'Considering': 0
            };
            
            allEnquiries.forEach(e => {
                if (e.boarding?.includes('Boarding')) counts['Boarding']++;
                else if (e.boarding?.includes('Day')) counts['Day']++;
                else if (e.boarding?.includes('Considering')) counts['Considering']++;
            });
            
            return {
                labels: Object.keys(counts),
                data: Object.values(counts)
            };
        }

        function getGenderDistribution() {
            const counts = {
                'Boys': 0,
                'Girls': 0
            };
            
            allEnquiries.forEach(e => {
                // Gender now comes directly from the API as e.gender
                if (e.gender === 'male') {
                    counts['Boys']++;
                } else if (e.gender === 'female') {
                    counts['Girls']++;
                }
            });
            
            return {
                labels: ['Boys', 'Girls'],
                data: [counts['Boys'], counts['Girls']]
            };
        }

        function getConversionFunnel() {
            const counts = {
                'New': allEnquiries.filter(e => e.status === 'new').length,
                'Contacted': allEnquiries.filter(e => e.status === 'contacted').length,
                'Open Day/Tour': allEnquiries.filter(e => e.status === 'openday' || e.status === 'privatetour').length,
                'Follow-up': allEnquiries.filter(e => e.status === 'followup').length,
                'Applying': allEnquiries.filter(e => e.status === 'applying').length,
                'Accepted': allEnquiries.filter(e => e.status === 'accepted').length
            };
            
            return {
                labels: Object.keys(counts),
                data: Object.values(counts)
            };
        }

        // ========================================
        // EXPORT FUNCTION
        // ========================================
        function exportEnquiries() {
            if (filteredEnquiries.length === 0) {
                alert('No enquiries to export');
                return;
            }
            
            // Create CSV
            let csv = 'Date,Time,Child,Family,Email,Contact,Form Entry,Entry Year,Boarding,Status,Priority\n';
            
            filteredEnquiries.forEach(e => {
                const date = new Date(e.created_at);
                const dateStr = date.toLocaleDateString('en-GB');
                const timeStr = date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                
                csv += `"${dateStr}","${timeStr}","${e.first_name}","${e.family_surname}","${e.parent_email}","${e.contact_number || ''}","${e.country || ''}","${e.form_entry || ''}","${e.entry_year || ''}","${e.boarding || ''}","${e.status}","${e.priority ? 'Yes' : 'No'}"\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cheltenham-enquiries-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Enquiries exported successfully');
        }

        // ========================================
        // OPEN DAYS FUNCTIONS
        // ========================================
        async function loadOpenDays() {
            showLoading('opendays-content');
            
            try {
                const includePast = document.getElementById('showPastEvents')?.checked || false;
                const res = await fetch('/api/admin/open-days?include_past=' + includePast);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                currentOpenDays = data.openDays || [];
                
                if (currentOpenDays.length === 0) {
                    document.getElementById('opendays-content').innerHTML = 
                        `<div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <div class="empty-state-text">No open days found</div>
                        </div>`;
                    return;
                }
                
                let html = '';
                currentOpenDays.forEach(event => {
                    const eventDate = new Date(event.event_date);
                    const isPast = eventDate < new Date();
                    const isActive = event.is_active !== false;
                    const status = isPast ? 'past' : (isActive ? 'active' : 'inactive');
                    
                    html += `<div class="open-day-card ${!isActive ? 'inactive' : ''}">`;
                    html += `<div class="open-day-header-row">`;
                    html += `<div>`;
                    html += `<div class="open-day-title">${event.event_name}</div>`;
                    html += `<div class="open-day-date">${eventDate.toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'})}</div>`;
                    if (event.event_time) html += `<div class="open-day-time">üïê ${event.event_time}</div>`;
                    html += `</div>`;
                    html += `<span class="badge badge-${status}">${status}</span>`;
                    html += `</div>`;
                    
                    if (event.description) {
                        html += `<div class="open-day-description">${event.description}</div>`;
                    }
                    
                    if (event.booking_url) {
                        html += `<a href="${event.booking_url}" target="_blank" class="open-day-booking">üîó Booking link</a>`;
                    }
                    
                    html += `<div class="open-day-actions">`;
                    html += `<button class="btn btn-secondary btn-sm" onclick="editOpenDay(${event.id})">Edit</button>`;
                    
                    if (isActive) {
                        html += `<button class="btn btn-danger btn-sm" onclick="deleteOpenDay(${event.id})">Delete</button>`;
                    } else {
                        html += `<button class="btn btn-success btn-sm" onclick="reactivateOpenDay(${event.id})">Reactivate</button>`;
                    }
                    
                    html += `</div>`;
                    html += `</div>`;
                });
                
                document.getElementById('opendays-content').innerHTML = html;
                
            } catch (error) {
                document.getElementById('opendays-content').innerHTML = 
                    `<div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-text">Error: ${error.message}</div>
                    </div>`;
            }
        }
        
        function openAddOpenDayModal() {
            document.getElementById('openDayModalTitle').textContent = 'Add Open Day';
            document.getElementById('openDayForm').reset();
            document.getElementById('openDayId').value = '';
            document.getElementById('openDayModal').classList.add('active');
        }
        
        function editOpenDay(id) {
            const event = currentOpenDays.find(e => e.id === id);
            if (!event) return;
            
            document.getElementById('openDayModalTitle').textContent = 'Edit Open Day';
            document.getElementById('openDayId').value = event.id;
            document.getElementById('eventName').value = event.event_name;
            document.getElementById('eventDate').value = event.event_date;
            document.getElementById('eventTime').value = event.event_time || '';
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('bookingUrl').value = event.booking_url || '';
            document.getElementById('openDayModal').classList.add('active');
        }
        
        function closeOpenDayModal() {
            document.getElementById('openDayModal').classList.remove('active');
        }
        
        async function saveOpenDay(e) {
            e.preventDefault();
            
            const id = document.getElementById('openDayId').value;
            const data = {
                event_name: document.getElementById('eventName').value,
                event_date: document.getElementById('eventDate').value,
                event_time: document.getElementById('eventTime').value,
                description: document.getElementById('eventDescription').value,
                booking_url: document.getElementById('bookingUrl').value
            };
            
            try {
                const url = id ? '/api/admin/open-days/' + id : '/api/admin/open-days';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (!result.success) throw new Error(result.error);
                
                closeOpenDayModal();
                loadOpenDays();
                showNotification('Open day saved successfully!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function deleteOpenDay(id) {
            if (!confirm('Delete this open day?')) return;
            
            try {
                const res = await fetch('/api/admin/open-days/' + id, {method: 'DELETE'});
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                loadOpenDays();
                showNotification('Open day deleted');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function reactivateOpenDay(id) {
            try {
                const res = await fetch('/api/admin/open-days/' + id, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({is_active: true})
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                loadOpenDays();
                showNotification('Open day reactivated');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        async function loadSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const data = await res.json();
                
                if (data.success) {
                    const autoDisplay = data.settings.auto_display_prospectus;
                    document.getElementById('autoDisplayToggle').checked = autoDisplay;
                    updateSettingsUI(autoDisplay);
                    
                    // Load email template
                    if (data.settings.email_template) {
                        document.getElementById('emailTemplateText').value = data.settings.email_template;
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Failed to load settings');
            }
        }
        
        async function updateSettings() {
            const autoDisplay = document.getElementById('autoDisplayToggle').checked;
            
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auto_display_prospectus: autoDisplay })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    updateSettingsUI(autoDisplay);
                    showNotification('Settings saved successfully!');
                } else {
                    throw new Error('Failed to update settings');
                }
            } catch (error) {
                console.error('Error updating settings:', error);
                alert('Failed to update settings');
                document.getElementById('autoDisplayToggle').checked = !autoDisplay;
            }
        }
        
        function updateSettingsUI(autoDisplay) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const toggleLabel = document.getElementById('toggleLabel');
            
            if (autoDisplay) {
                indicator.className = 'status-indicator on';
                statusText.innerHTML = '<strong>Status: ENABLED</strong> - Prospectus auto-displays after form submission';
                toggleLabel.textContent = 'Auto-display is ON';
            } else {
                indicator.className = 'status-indicator off';
                statusText.innerHTML = '<strong>Status: DISABLED</strong> - Admissions team manually emails prospectus links';
                toggleLabel.textContent = 'Auto-display is OFF';
            }
        }

        async function saveEmailTemplate() {
            const template = document.getElementById('emailTemplateText').value;
            
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email_template: template })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('Email template saved successfully!');
                } else {
                    throw new Error('Failed to save template');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Failed to save email template');
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = '‚úì ' + message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = 
                `<div class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>`;
        }

        // Close modals when clicking outside
        document.getElementById('emailDraftModal').addEventListener('click', function(e) {
            if (e.target === this) closeEmailModal();
        });
        
        document.getElementById('openDayModal').addEventListener('click', function(e) {
            if (e.target === this) closeOpenDayModal();
        });

        document.getElementById('enquiryDetailModal').addEventListener('click', function(e) {
            if (e.target === this) closeEnquiryDetailModal();
        });

        // Load enquiries on page load
        loadEnquiries();

        // ========================================
// ENHANCED SESSION TRACKING FUNCTIONS
// ========================================

async function loadEnquirySessions(enquiryId) {
    try {
        const [sessionsRes, modulesRes] = await Promise.all([
            fetch(`/api/enquiry/${enquiryId}/sessions`),
            fetch(`/api/enquiry/${enquiryId}/modules-detailed`)
        ]);
        
        const sessionsData = await sessionsRes.json();
        const modulesData = await modulesRes.json();
        
        if (sessionsData.success && modulesData.success) {
            // Update summary stats
            updateSessionSummary(sessionsData.summary || {
                totalSessions: sessionsData.sessions.length,
                totalTime: sessionsData.sessions.reduce((sum, s) => sum + (s.total_time_seconds || 0), 0),
                uniqueModules: new Set(sessionsData.sessions.flatMap(s => s.modules || [])).size
            });
            
            renderSessionHistory(sessionsData.sessions);
            renderModuleDetails(modulesData.modules);
        }
    } catch (error) {
        console.error('Error loading enquiry sessions:', error);
        document.getElementById('sessionHistoryContent').innerHTML = `
            <div class="no-sessions-message">
                <div class="icon">‚ö†Ô∏è</div>
                <p>Failed to load session data</p>
            </div>
        `;
    }
}

function updateSessionSummary(summary) {
    const totalSessionsEl = document.getElementById('totalSessionsCount');
    const totalTimeEl = document.getElementById('totalTimeSpent');
    const uniqueModulesEl = document.getElementById('uniqueModulesViewed');
    
    if (totalSessionsEl) {
        totalSessionsEl.textContent = summary.totalSessions || 0;
    }
    
    if (totalTimeEl) {
        const minutes = Math.floor((summary.totalTime || 0) / 60);
        const seconds = (summary.totalTime || 0) % 60;
        totalTimeEl.textContent = `${minutes}m ${seconds}s`;
    }
    
    if (uniqueModulesEl) {
        uniqueModulesEl.textContent = summary.uniqueModules || 0;
    }
}

function renderSessionHistory(sessions) {
    const container = document.getElementById('sessionHistoryContent');
    if (!container) return;
    
    if (!sessions || sessions.length === 0) {
        container.innerHTML = `
            <div class="no-sessions-message">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#cbd5e1" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                </div>
                <p style="font-weight: 500; color: #475569; margin-bottom: 8px;">No viewing sessions yet</p>
                <p style="font-size: 14px; color: #94a3b8;">Sessions will appear here once the prospectus is opened</p>
            </div>
        `;
        return;
    }
    
    const timeline = document.createElement('div');
    timeline.className = 'session-timeline';
    
    sessions.forEach(session => {
        const isActive = !session.ended_at;
        const startDate = new Date(session.started_at);
        const duration = session.total_time_seconds || session.total_time || 0;
        const durationMins = Math.floor(duration / 60);
        const durationSecs = duration % 60;
        
        const sessionEl = document.createElement('div');
        sessionEl.className = `session-item ${isActive ? 'active' : ''}`;
        
        // Get modules array, handling different possible data structures
        const modules = session.modules || [];
        const modulesViewed = session.modules_viewed || modules.length;
        
        sessionEl.innerHTML = `
            <div class="session-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div>
                    <div style="font-size: 15px; font-weight: 600; color: #1e3a5f; margin-bottom: 4px;">
                        ${startDate.toLocaleDateString('en-GB', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}
                    </div>
                    <div style="font-size: 13px; color: #64748b;">
                        ${startDate.toLocaleTimeString('en-GB', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })}
                        ${isActive ? 
                            '<span class="session-status-badge active" style="margin-left: 8px; padding: 2px 8px; background: #10b981; color: white; border-radius: 4px; font-size: 11px; font-weight: 600;">üî¥ ACTIVE NOW</span>' : 
                            '<span class="session-status-badge ended" style="margin-left: 8px; padding: 2px 8px; background: #64748b; color: white; border-radius: 4px; font-size: 11px; font-weight: 600;">ENDED</span>'
                        }
                    </div>
                </div>
                <div style="background: #f1f5f9; padding: 8px 12px; border-radius: 8px; font-weight: 600; color: #1e3a5f; text-align: center;">
                    <div style="font-size: 18px;">${durationMins}m ${durationSecs}s</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Duration</div>
                </div>
            </div>
            
            <div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">
                ${modulesViewed} module${modulesViewed !== 1 ? 's' : ''} viewed
            </div>
            
            <div class="session-modules" style="display: flex; flex-wrap: wrap; gap: 6px;">
                ${modules.length > 0 ? modules.map(module => `
                    <div style="background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                        ${formatModuleName(module)}
                    </div>
                `).join('') : '<span style="color: #94a3b8; font-size: 13px;">No module details available</span>'}
            </div>
        `;
        
        timeline.appendChild(sessionEl);
    });
    
    container.innerHTML = '';
    container.appendChild(timeline);
}

function renderModuleDetails(modules) {
    const container = document.getElementById('moduleDetailsContent');
    if (!container) return;
    
    if (!modules || modules.length === 0) {
        container.innerHTML = `
            <div class="no-sessions-message">
                <div style="width: 60px; height: 60px; margin: 0 auto 16px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <div style="width: 24px; height: 24px; background: #cbd5e1; border-radius: 4px;"></div>
                </div>
                <p style="font-weight: 500; color: #475569;">No modules viewed yet</p>
            </div>
        `;
        return;
    }
    
    const grid = document.createElement('div');
    grid.className = 'module-details-grid';
    grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;';
    
    modules.forEach(module => {
        // FIX: Use avg_time_per_view as the actual time (it's more accurate)
        // When view_count = 1, avg_time_per_view IS the total time
        const actualTimeSeconds = module.avg_time_per_view || module.time_spent_seconds || 0;
        const totalMins = Math.floor(actualTimeSeconds / 60);
        const totalSecs = actualTimeSeconds % 60;
        
        // Only show separate avg if there are multiple views
        const showAverage = (module.view_count || 0) > 1;
        const avgMins = showAverage ? Math.floor((module.avg_time_per_view || 0) / 60) : 0;
        const avgSecs = showAverage ? Math.floor((module.avg_time_per_view || 0) % 60) : 0;
        
        const moduleEl = document.createElement('div');
        moduleEl.style.cssText = 'background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; transition: all 0.2s;';
        
        moduleEl.innerHTML = `
            <div style="font-size: 15px; font-weight: 600; color: #1e3a5f; margin-bottom: 12px;">
                ${formatModuleName(module.module_name)}
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <div style="background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${module.view_count || 0}</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Views</div>
                </div>
                <div style="background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${totalMins}m ${totalSecs}s</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Time Spent</div>
                </div>
                ${showAverage ? `
                    <div style="background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${avgMins}m ${avgSecs}s</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Avg/View</div>
                    </div>
                ` : ''}
                <div style="background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 20px; font-weight: 700; color: #0369a1;">${Math.round(module.avg_scroll_depth || 0)}%</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 2px;">Scroll Depth</div>
                </div>
            </div>
        `;
        
        grid.appendChild(moduleEl);
    });
    
    container.innerHTML = '';
    container.appendChild(grid);
}


// Helper function to format module names nicely
function formatModuleName(name) {
    if (!name) return 'Unknown Module';
    
    // Remove common prefixes
    name = name.replace(/^module-/, '').replace(/^section-/, '');
    
    // Convert dashes and underscores to spaces
    name = name.replace(/[-_]/g, ' ');
    
    // Capitalize each word
    return name.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}


function formatModuleName(name) {
    return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
    };
    
    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / secondsInUnit);
        if (interval >= 1) {
            return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
        }
    }
    return 'just now';
}
    </script>
</body>
</html>